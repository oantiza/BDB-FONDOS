<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BDB-FONDOS ‚Äî Estructura del Sistema</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
  :root {
    --primary: #1e40af;
    --primary-light: #dbeafe;
    --secondary: #0369a1;
    --accent: #0284c7;
    --success: #15803d;
    --success-light: #dcfce7;
    --warning: #b45309;
    --warning-light: #fef3c7;
    --gray-50: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-700: #334155;
    --gray-800: #1e293b;
    --gray-900: #0f172a;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    line-height: 1.6;
    color: var(--gray-800);
    background: #fff;
    max-width: 960px;
    margin: 0 auto;
    padding: 40px 48px;
  }
  /* COVER */
  .cover {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    border-left: 6px solid var(--primary);
    padding: 32px 32px 32px 36px;
    margin-bottom: 48px;
    background: var(--gray-50);
    border-radius: 0 12px 12px 0;
  }
  .cover .label { font-size: 11px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--accent); margin-bottom: 10px; }
  .cover h1 { font-size: 28px; font-weight: 700; color: var(--gray-900); margin-bottom: 6px; }
  .cover .subtitle { font-size: 14px; color: var(--gray-700); margin-bottom: 16px; }
  .cover .meta { display: flex; gap: 20px; font-size: 12px; color: #64748b; }
  .cover .meta span { display: flex; align-items: center; gap: 4px; }

  /* SECTIONS */
  h2 {
    font-size: 16px; font-weight: 700; color: var(--primary);
    border-bottom: 2px solid var(--primary-light);
    padding-bottom: 6px; margin: 36px 0 16px;
    display: flex; align-items: center; gap: 8px;
  }
  h3 { font-size: 13px; font-weight: 600; color: var(--gray-800); margin: 20px 0 8px; }

  /* TABLES */
  table { width: 100%; border-collapse: collapse; margin: 12px 0 20px; font-size: 12px; }
  thead tr { background: var(--primary); color: white; }
  thead th { padding: 8px 12px; text-align: left; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; }
  tbody tr:nth-child(even) { background: var(--gray-50); }
  tbody tr:hover { background: var(--primary-light); }
  td { padding: 7px 12px; border-bottom: 1px solid var(--gray-200); vertical-align: top; }
  td:first-child { font-family: 'JetBrains Mono', monospace; font-size: 11px; white-space: nowrap; color: var(--secondary); font-weight: 500; }
  .star { color: #f59e0b; }

  /* BADGES */
  .badge {
    display: inline-block; padding: 1px 7px; border-radius: 99px;
    font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;
  }
  .badge-blue { background: var(--primary-light); color: var(--primary); }
  .badge-green { background: var(--success-light); color: var(--success); }
  .badge-yellow { background: var(--warning-light); color: var(--warning); }

  /* CODE */
  pre, code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    background: var(--gray-900);
    color: #e2e8f0;
    border-radius: 8px;
    padding: 16px 20px;
    overflow-x: auto;
    margin: 10px 0 16px;
    line-height: 1.7;
  }
  .code-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.08em; margin-bottom: 2px; }
  code:not(pre code) {
    display: inline; padding: 1px 6px; border-radius: 4px;
    font-size: 11px; background: var(--gray-100); color: var(--secondary);
  }
  .comment { color: #6272a4; }
  .kw { color: #ff79c6; }
  .str { color: #f1fa8c; }
  .field { color: #8be9fd; }
  .val { color: #bd93f9; }

  /* FOLDER TREE */
  .tree {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px; line-height: 1.8;
    background: var(--gray-900); color: #e2e8f0;
    border-radius: 8px; padding: 20px 24px;
    margin: 8px 0 20px;
  }
  .tree .dir { color: #8be9fd; font-weight: 500; }
  .tree .file { color: #f8f8f2; }
  .tree .note { color: #6272a4; font-size: 11px; }

  /* FLOW DIAGRAM */
  .flow {
    display: flex; flex-direction: column; gap: 0;
    margin: 12px 0 24px;
  }
  .flow-step {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 16px;
    border-left: 3px solid var(--primary-light);
  }
  .flow-step:first-child { border-top-left-radius: 8px; border-top: 2px solid var(--primary-light); }
  .flow-step:last-child { border-bottom-left-radius: 8px; border-bottom: 2px solid var(--primary-light); }
  .flow-step:nth-child(odd) { background: var(--gray-50); }
  .step-num {
    min-width: 28px; height: 28px; border-radius: 50%;
    background: var(--primary); color: white;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700; flex-shrink: 0;
  }
  .step-file { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--secondary); font-weight: 500; margin-bottom: 2px; }
  .step-desc { font-size: 12px; color: var(--gray-700); }

  /* SCHEMA BLOCK */
  .schema-block {
    border: 1px solid var(--gray-200);
    border-radius: 10px; overflow: hidden;
    margin: 12px 0 20px;
  }
  .schema-header {
    background: var(--primary); color: white;
    padding: 8px 16px;
    font-size: 12px; font-weight: 600;
    display: flex; justify-content: space-between; align-items: center;
  }
  .schema-body { padding: 4px 0; }
  .schema-row {
    display: grid; grid-template-columns: 200px 100px 1fr;
    padding: 6px 16px; border-bottom: 1px solid var(--gray-100);
    font-size: 12px;
  }
  .schema-row:last-child { border-bottom: none; }
  .schema-row:nth-child(even) { background: var(--gray-50); }
  .field-name { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--secondary); font-weight: 500; }
  .field-type { color: var(--warning); font-size: 11px; }
  .field-desc { color: var(--gray-700); }

  /* DIVIDER */
  hr { border: none; border-top: 1px solid var(--gray-200); margin: 32px 0; }

  /* CMD BOX */
  .cmd-box {
    background: #0f1e2e; border-radius: 10px; padding: 20px 24px;
    margin: 12px 0; border-left: 4px solid var(--accent);
  }
  .cmd-box .cmd-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: #60a5fa; font-weight: 600; margin-bottom: 8px; }
  .cmd-box pre { background: transparent; padding: 0; color: #e2e8f0; font-size: 11.5px; }

  /* PRINT */
  @media print {
    body { padding: 20px 32px; }
    h2 { break-before: auto; }
    .cover { break-after: page; }
    pre, .tree, .cmd-box { break-inside: avoid; }
    table { break-inside: avoid; }
  }
  @page { margin: 15mm 20mm; }
</style>
</head>
<body>

<!-- COVER -->
<div class="cover">
  <div class="label">Documentaci√≥n T√©cnica</div>
  <h1>üèóÔ∏è BDB-FONDOS</h1>
  <div class="subtitle">Informe de Estructura del Sistema y Base de Datos</div>
  <div class="meta">
    <span>üìÖ 20 Febrero 2026</span>
    <span>üìÅ Proyecto: BDB-FONDOS</span>
    <span>üîñ Versi√≥n: Production</span>
  </div>
</div>

<!-- ESTRUCTURA RA√çZ -->
<h2>üìÅ Estructura Ra√≠z del Proyecto</h2>
<div class="tree">
BDB-FONDOS/<br>
‚îú‚îÄ‚îÄ <span class="dir">frontend/</span>             <span class="note">‚Üí Aplicaci√≥n React (Vite + TypeScript)</span><br>
‚îú‚îÄ‚îÄ <span class="dir">functions_python/</span>     <span class="note">‚Üí Backend Cloud Functions (Python 3.12)</span><br>
‚îú‚îÄ‚îÄ <span class="dir">scripts/</span>              <span class="note">‚Üí Scripts utilitarios JavaScript</span><br>
‚îú‚îÄ‚îÄ <span class="dir">.agent/</span>               <span class="note">‚Üí Workflows del agente IA</span><br>
‚îú‚îÄ‚îÄ <span class="file">firebase.json</span>         <span class="note">‚Üí Configuraci√≥n deploy Firebase Hosting + Functions</span><br>
‚îú‚îÄ‚îÄ <span class="file">firestore.rules</span>       <span class="note">‚Üí Reglas de seguridad Firestore</span><br>
‚îú‚îÄ‚îÄ <span class="file">firestore.indexes.json</span> <span class="note">‚Üí √çndices compuestos de Firestore</span><br>
‚îú‚îÄ‚îÄ <span class="file">fondos_con_retrocesion.csv</span> <span class="note">‚Üí CSV retrocesiones (287 fondos)</span><br>
‚îú‚îÄ‚îÄ <span class="file">fondos_no_encontrados.csv</span>  <span class="note">‚Üí 72 fondos sin entrada en BD</span><br>
‚îî‚îÄ‚îÄ <span class="file">serviceAccountKey.json</span> <span class="note">‚Üí Clave servicio Firebase (privada)</span><br>
</div>

<!-- FRONTEND -->
<h2>üñ•Ô∏è Frontend ‚Äî <code>frontend/src/</code></h2>

<h3>üìÑ P√°ginas (<code>pages/</code>)</h3>
<table>
  <thead><tr><th>Archivo</th><th>Descripci√≥n</th></tr></thead>
  <tbody>
    <tr><td>DashboardPage.tsx</td><td>P√°gina principal ‚Äî cartera activa, optimizaci√≥n, rebalanceo, fondos VIP</td></tr>
    <tr><td>XRayPage.tsx</td><td>An√°lisis X-Ray de la cartera + generaci√≥n de informes PDF</td></tr>
    <tr><td>XRayAnalyticsPage.tsx</td><td>Analytics avanzados: backtesting, stress tests, correlaciones</td></tr>
    <tr><td>ComparatorPage.tsx</td><td>Comparador de carteras con benchmarks sint√©ticos</td></tr>
    <tr><td>RetirementCalculatorPage.tsx</td><td>Calculadora de planificaci√≥n de jubilaci√≥n</td></tr>
    <tr><td>MiBoutiquePage.tsx</td><td>Explorador Mi Boutique de fondos</td></tr>
  </tbody>
</table>

<h3>ü™ù Hooks principales (<code>hooks/</code>)</h3>
<table>
  <thead><tr><th>Archivo</th><th>Descripci√≥n</th></tr></thead>
  <tbody>
    <tr><td>usePortfolioActions.ts <span class="star">‚òÖ</span></td><td>L√≥gica central: generar, optimizar, rebalancear, importar/exportar cartera</td></tr>
    <tr><td>usePortfolioStats.ts <span class="star">‚òÖ</span></td><td>C√°lculo de m√©tricas (Sharpe, volatilidad, drawdown, atribuci√≥n)</td></tr>
    <tr><td>usePortfolio.ts</td><td>Estado global y persistencia de la cartera en memoria</td></tr>
    <tr><td>useAssets.ts</td><td>Carga de fondos desde Firestore <code>funds_v3</code></td></tr>
    <tr><td>useXRayData.ts</td><td>Datos para X-Ray: exposiciones, sectores, geograf√≠a</td></tr>
    <tr><td>useXRayAnalytics.ts</td><td>Analytics avanzados del X-Ray</td></tr>
    <tr><td>useSavedPortfolios.ts</td><td>Guardar/cargar carteras en Firestore</td></tr>
    <tr><td>useSyntheticBenchmarks.ts</td><td>Carga de benchmarks sint√©ticos desde Firestore</td></tr>
    <tr><td>useFundHistory.ts</td><td>Historial de precios de un fondo espec√≠fico</td></tr>
    <tr><td>useDashboardData.ts</td><td>Datos del dashboard (clientes, carteras de usuario)</td></tr>
  </tbody>
</table>

<h3>üõ†Ô∏è Utilidades (<code>utils/</code>)</h3>
<table>
  <thead><tr><th>Archivo</th><th>Descripci√≥n</th></tr></thead>
  <tbody>
    <tr><td>rulesEngine.ts <span class="star">‚òÖ</span></td><td>Motor de reglas local: selecci√≥n de cartera por perfil de riesgo sin backend</td></tr>
    <tr><td>directSearch.ts <span class="star">‚òÖ</span></td><td>B√∫squeda directa de alternativas en <code>funds_v3</code> (asset_class + regi√≥n)</td></tr>
    <tr><td>fundSwapper.ts</td><td>L√≥gica de intercambio de fondos con alternativas similares</td></tr>
    <tr><td>normalizer.ts</td><td>Normalizaci√≥n fondos V3 ‚Üí formato interno de la app</td></tr>
    <tr><td>statistics.ts</td><td>Estad√≠sticas financieras: Sharpe, volatilidad, correlaci√≥n, CAGR</td></tr>
    <tr><td>analytics.ts</td><td>Anal√≠ticas de rendimiento y atribuci√≥n de resultados</td></tr>
    <tr><td>pdfGenerator.ts</td><td>Generaci√≥n de informes PDF (XRay, cartera completa)</td></tr>
    <tr><td>comparatorPdfGenerator.ts</td><td>PDF del comparador de carteras</td></tr>
    <tr><td>benchmarkUtils.ts</td><td>Utilidades para benchmarks (c√°lculo de tracking error, etc.)</td></tr>
    <tr><td>csvImport.ts</td><td>Importaci√≥n de carteras desde CSV</td></tr>
  </tbody>
</table>

<h3>ü™ü Modales clave (<code>components/modals/</code>)</h3>
<table>
  <thead><tr><th>Archivo</th><th>Funci√≥n</th></tr></thead>
  <tbody>
    <tr><td>SharpeMaximizerModal.tsx <span class="star">‚òÖ</span></td><td>Buscador Sharpe: simula fondos que mejoran el Sharpe, con opci√≥n de priorizar retrocesi√≥n</td></tr>
    <tr><td>TacticalModal.tsx <span class="star">‚òÖ</span></td><td>Modal de rebalanceo: detalle de compras/ventas necesarias para aplicar la propuesta</td></tr>
    <tr><td>OptimizationReviewModal.tsx</td><td>Revisi√≥n y aprobaci√≥n de la propuesta de optimizaci√≥n</td></tr>
    <tr><td>MacroTacticalModal.tsx</td><td>Ajuste macroecon√≥mico t√°ctico de la cartera</td></tr>
    <tr><td>CostsModal.tsx</td><td>An√°lisis de costes: TER, retrocesi√≥n, coste neto</td></tr>
    <tr><td>VipFundsModal.tsx</td><td>Gesti√≥n de fondos VIP (fondos forzados en la cartera)</td></tr>
    <tr><td>SavedPortfoliosModal.tsx</td><td>Carteras guardadas por usuario</td></tr>
    <tr><td>UpdateHistoryModal.tsx</td><td>Actualizaci√≥n manual del historial de precios</td></tr>
  </tbody>
</table>

<hr>

<!-- BACKEND -->
<h2>‚öôÔ∏è Backend ‚Äî <code>functions_python/</code></h2>

<h3>üìå Punto de entrada</h3>
<table>
  <thead><tr><th>Archivo</th><th>Descripci√≥n</th></tr></thead>
  <tbody>
    <tr><td>main.py</td><td>Entry point de Cloud Functions ‚Äî rutas HTTP y Callable Functions (Firebase)</td></tr>
  </tbody>
</table>

<h3>üîß Servicios (<code>services/</code>)</h3>
<table>
  <thead><tr><th>Archivo</th><th>Descripci√≥n</th></tr></thead>
  <tbody>
    <tr><td>optimizer.py <span class="star">‚òÖ</span></td><td>Optimizador Markowitz: Efficient Frontier, Max Sharpe, restricciones por perfil de riesgo (PyPortfolioOpt)</td></tr>
    <tr><td>data_fetcher.py <span class="star">‚òÖ</span></td><td>Obtenci√≥n y alineaci√≥n de series hist√≥ricas de precios (hasta 5 a√±os)</td></tr>
    <tr><td>config.py</td><td>Constantes del sistema: perfiles de riesgo, l√≠mites de pesos, buckets de activos</td></tr>
    <tr><td>financial_engine.py</td><td>M√©tricas financieras: Sharpe, CAGR, volatilidad, max drawdown</td></tr>
    <tr><td>analytics.py</td><td>Analytics avanzados de cartera y atribuci√≥n</td></tr>
    <tr><td>backtester.py</td><td>Backtesting de carteras con datos hist√≥ricos reales</td></tr>
    <tr><td>calc_service.py</td><td>C√°lculo batch de m√©tricas para todos los fondos</td></tr>
    <tr><td>daily_service.py</td><td>Servicio diario: recalcular m√©tricas, sincronizar datos NAV</td></tr>
    <tr><td>nav_fetcher.py</td><td>Descargador autom√°tico de NAVs (VL) de fondos desde APIs externas</td></tr>
    <tr><td>research.py</td><td>Investigaci√≥n y enriquecimiento de datos de fondos</td></tr>
    <tr><td>audit_service.py</td><td>Auditor√≠a y verificaci√≥n de calidad de datos en Firestore</td></tr>
    <tr><td>fix_service.py</td><td>Correcciones masivas de datos en base de datos</td></tr>
    <tr><td>history_writer.py</td><td>Escritura de historial de precios en Firestore</td></tr>
    <tr><td>pdf_generator.py</td><td>Generaci√≥n de PDFs en el backend (para informes pesados)</td></tr>
  </tbody>
</table>

<h3>üìú Scripts (<code>functions_python/scripts/</code>)</h3>
<table>
  <thead><tr><th>Archivo</th><th>Descripci√≥n</th></tr></thead>
  <tbody>
    <tr><td>check_and_import_retrocesion.py</td><td>Importaci√≥n y verificaci√≥n de retrocesiones desde CSV a Firestore</td></tr>
    <tr><td>generate_benchmarks.py</td><td>Generaci√≥n de benchmarks sint√©ticos a partir de fondos reales</td></tr>
    <tr><td>recalc_metrics_batch.py</td><td>Recalcular m√©tricas (Sharpe, CAGR, etc.) de todos los fondos en lote</td></tr>
    <tr><td>audit_fund_data.py</td><td>Auditor√≠a completa de calidad de datos de fondos</td></tr>
    <tr><td>fix_data_anomalies.py</td><td>Correcci√≥n de anomal√≠as en datos hist√≥ricos de precios</td></tr>
  </tbody>
</table>

<hr>

<!-- FIRESTORE -->
<h2>üóÑÔ∏è Base de Datos ‚Äî Firestore</h2>

<h3><code>funds_v3</code> ‚Äî Cat√°logo de Fondos</h3>
<p style="font-size:12px;color:#64748b;margin-bottom:10px;">~2.500 documentos | ID = ISIN del fondo</p>
<div class="schema-block">
  <div class="schema-header"><span>Documento: funds_v3/{ISIN}</span><span class="badge" style="background:#60a5fa22;color:#93c5fd">Principal</span></div>
  <div class="schema-body">
    <div class="schema-row"><span class="field-name">isin</span><span class="field-type">string</span><span class="field-desc">ISIN del fondo (tambi√©n es el ID del documento)</span></div>
    <div class="schema-row"><span class="field-name">name</span><span class="field-type">string</span><span class="field-desc">Nombre completo del fondo</span></div>
    <div class="schema-row"><span class="field-name">currency</span><span class="field-type">string</span><span class="field-desc">Divisa (EUR, USD, GBP...)</span></div>
    <div class="schema-row"><span class="field-name">has_history</span><span class="field-type">boolean</span><span class="field-desc">Tiene datos hist√≥ricos de precios en historico_vl_v2</span></div>
    <div class="schema-row"><span class="field-name">ms.*</span><span class="field-type">map</span><span class="field-desc">Datos Morningstar: categor√≠a, rating, costes, sectores, regiones, top 10 posiciones</span></div>
    <div class="schema-row"><span class="field-name">derived.*</span><span class="field-type">map</span><span class="field-desc">Clasificaci√≥n interna: asset_class (RV/RF/Mixto/Monetario), primary_region, confidence</span></div>
    <div class="schema-row"><span class="field-name">manual.costs.retrocession</span><span class="field-type">number</span><span class="field-desc">% retrocesi√≥n BDB (fuente: CSV fondos_con_retrocesion.csv)</span></div>
    <div class="schema-row"><span class="field-name">manual.costs.ter</span><span class="field-type">number</span><span class="field-desc">TER total del fondo</span></div>
    <div class="schema-row"><span class="field-name">std_perf.*</span><span class="field-type">map</span><span class="field-desc">M√©tricas calculadas: return (CAGR 3Y), volatility, sharpe, max_drawdown, cvar95, var95</span></div>
    <div class="schema-row"><span class="field-name">quality.*</span><span class="field-type">map</span><span class="field-desc">Calidad del dato: ok (bool), parser_version, warnings, parsed_at</span></div>
    <div class="schema-row"><span class="field-name">data_quality.*</span><span class="field-type">map</span><span class="field-desc">std_perf_ok, history_ok, last_checked_at</span></div>
    <div class="schema-row"><span class="field-name">last_sync</span><span class="field-type">Timestamp</span><span class="field-desc">√öltima sincronizaci√≥n de datos de mercado</span></div>
  </div>
</div>

<h3><code>historico_vl_v2</code> ‚Äî Historial de Precios</h3>
<div class="schema-block">
  <div class="schema-header"><span>Documento: historico_vl_v2/{ISIN}</span><span class="badge" style="background:#60a5fa22;color:#93c5fd">Serie temporal</span></div>
  <div class="schema-body">
    <div class="schema-row"><span class="field-name">data</span><span class="field-type">map</span><span class="field-desc">Mapa date‚Üíprice: { "2024-01-02": 142.35, "2024-01-03": 143.10, ... }</span></div>
    <div class="schema-row"><span class="field-name">source</span><span class="field-type">string</span><span class="field-desc">Origen del dato: morningstar | manual | nav_fetcher</span></div>
    <div class="schema-row"><span class="field-name">last_updated</span><span class="field-type">Timestamp</span><span class="field-desc">√öltima actualizaci√≥n del historial</span></div>
  </div>
</div>

<h3><code>users/{uid}/portfolios</code> ‚Äî Carteras de Usuario</h3>
<div class="schema-block">
  <div class="schema-header"><span>Subcolecci√≥n: users/{uid}/portfolios/{pid}</span></div>
  <div class="schema-body">
    <div class="schema-row"><span class="field-name">name</span><span class="field-type">string</span><span class="field-desc">Nombre de la cartera</span></div>
    <div class="schema-row"><span class="field-name">items</span><span class="field-type">array</span><span class="field-desc">Lista de posiciones: [{isin, name, weight, value}]</span></div>
    <div class="schema-row"><span class="field-name">risk_level</span><span class="field-type">number</span><span class="field-desc">Perfil de riesgo (1‚Äì10)</span></div>
    <div class="schema-row"><span class="field-name">total_capital</span><span class="field-type">number</span><span class="field-desc">Capital total de la cartera</span></div>
    <div class="schema-row"><span class="field-name">created_at</span><span class="field-type">Timestamp</span><span class="field-desc">Fecha de creaci√≥n</span></div>
  </div>
</div>

<h3><code>benchmarks</code> ‚Äî Benchmarks Sint√©ticos</h3>
<div class="schema-block">
  <div class="schema-header"><span>Documento: benchmarks/{id}</span></div>
  <div class="schema-body">
    <div class="schema-row"><span class="field-name">name</span><span class="field-type">string</span><span class="field-desc">Nombre del benchmark (ej. "Benchmark Agresivo")</span></div>
    <div class="schema-row"><span class="field-name">weights</span><span class="field-type">map</span><span class="field-desc">Pesos por ISIN: {"IE00B03HCZ61": 0.60, "LU0162660350": 0.40}</span></div>
    <div class="schema-row"><span class="field-name">std_perf.*</span><span class="field-type">map</span><span class="field-desc">M√©tricas precalculadas: sharpe, return, volatility</span></div>
    <div class="schema-row"><span class="field-name">created_by</span><span class="field-type">string</span><span class="field-desc">Email del usuario creador</span></div>
  </div>
</div>

<h3><code>config</code> ‚Äî Configuraci√≥n del Sistema</h3>
<div class="schema-block">
  <div class="schema-header"><span>Colecci√≥n: config/</span></div>
  <div class="schema-body">
    <div class="schema-row"><span class="field-name">auto_complete_candidates</span><span class="field-type">doc</span><span class="field-desc">ISINs candidatos para auto-expansi√≥n del universo de fondos</span></div>
    <div class="schema-row"><span class="field-name">risk_profiles</span><span class="field-type">doc</span><span class="field-desc">Par√°metros por perfil de riesgo (equity floor, bond cap, etc.)</span></div>
  </div>
</div>

<hr>

<!-- FLUJOS -->
<h2>üîÅ Flujos de Selecci√≥n y Rebalanceo</h2>

<h3>Sharpe Maximizer ‚Äî Selecci√≥n de fondos que mejoran la cartera</h3>
<div class="flow">
  <div class="flow-step">
    <div class="step-num">1</div>
    <div>
      <div class="step-file">SharpeMaximizerModal.tsx</div>
      <div class="step-desc">Usuario selecciona asset_class, regi√≥n y si priorizar retrocesi√≥n. Se lanza la b√∫squeda.</div>
    </div>
  </div>
  <div class="flow-step">
    <div class="step-num">2</div>
    <div>
      <div class="step-file">directSearch.ts ‚Üí funds_v3 (Firestore)</div>
      <div class="step-desc">Se consultan hasta 200 fondos (si priorizar retrocesi√≥n) o 50 fondos del mismo asset_class y regi√≥n.</div>
    </div>
  </div>
  <div class="flow-step">
    <div class="step-num">3</div>
    <div>
      <div class="step-file">SharpeMaximizerModal.tsx ‚Äî Simulaci√≥n local</div>
      <div class="step-desc">Para cada fondo candidato, se simula el impacto en el Sharpe de la cartera al a√±adirlo con un peso del 10%.</div>
    </div>
  </div>
  <div class="flow-step">
    <div class="step-num">4</div>
    <div>
      <div class="step-file">Ordenaci√≥n + presentaci√≥n</div>
      <div class="step-desc">Si "Priorizar Retrocesi√≥n": ordena por retrocesi√≥n DESC, luego por impacto Sharpe. Si no: solo por impacto Sharpe.</div>
    </div>
  </div>
  <div class="flow-step">
    <div class="step-num">5</div>
    <div>
      <div class="step-file">usePortfolioActions.ts ‚Üí setPortfolio()</div>
      <div class="step-desc">El usuario aprueba el fondo y se a√±ade a la cartera activa.</div>
    </div>
  </div>
</div>

<h3>Optimizaci√≥n / Rebalanceo ‚Äî Flujo completo</h3>
<div class="flow">
  <div class="flow-step">
    <div class="step-num">1</div>
    <div>
      <div class="step-file">DashboardPage.tsx ‚Üí Controls.tsx</div>
      <div class="step-desc">Usuario pulsa "Optimizar" o "Rebalancear" en la barra de controles.</div>
    </div>
  </div>
  <div class="flow-step">
    <div class="step-num">2</div>
    <div>
      <div class="step-file">usePortfolioActions.ts ‚Üí handleOptimize() / handleRebalance()</div>
      <div class="step-desc">Se construye el payload: ISINs de la cartera, nivel de riesgo, fondos bloqueados (VIP), metadatos de asset_class.</div>
    </div>
  </div>
  <div class="flow-step">
    <div class="step-num">3</div>
    <div>
      <div class="step-file">Firebase Cloud Function: optimize_portfolio_quant</div>
      <div class="step-desc">Llamada HTTP callable al backend Python desplegado en Firebase Functions.</div>
    </div>
  </div>
  <div class="flow-step">
    <div class="step-num">4</div>
    <div>
      <div class="step-file">main.py ‚Üí optimizer.py ‚Üí data_fetcher.py</div>
      <div class="step-desc">Se obtienen series hist√≥ricas de hasta 5 a√±os desde historico_vl_v2. Se alinean las fechas entre todos los fondos.</div>
    </div>
  </div>
  <div class="flow-step">
    <div class="step-num">5</div>
    <div>
      <div class="step-file">optimizer.py ‚Äî PyPortfolioOpt (EfficientFrontier)</div>
      <div class="step-desc">Se calcula la Frontera Eficiente y se busca el portfolio de M√°ximo Sharpe con restricciones por perfil de riesgo (equity floor, bond cap, max por fondo).</div>
    </div>
  </div>
  <div class="flow-step">
    <div class="step-num">6</div>
    <div>
      <div class="step-file">OptimizationReviewModal.tsx ‚Üí TacticalModal.tsx</div>
      <div class="step-desc">El resultado (pesos propuestos) se muestra para revisi√≥n. TacticalModal calcula las operaciones (compras/ventas) necesarias.</div>
    </div>
  </div>
  <div class="flow-step">
    <div class="step-num">7</div>
    <div>
      <div class="step-file">usePortfolioActions.ts ‚Üí setPortfolio()</div>
      <div class="step-desc">El usuario acepta y la cartera se actualiza con los nuevos pesos.</div>
    </div>
  </div>
</div>

<hr>

<!-- ZIP -->
<h2>üì¶ Generar ZIP con Archivos de L√≥gica</h2>
<p style="font-size:12px;color:#64748b;margin-bottom:12px;">Ejecuta este comando en PowerShell para crear el ZIP con todos los archivos clave:</p>
<div class="cmd-box">
  <div class="cmd-label">PowerShell</div>
  <pre>Compress-Archive -Path `
  "c:\Users\oanti\Documents\BDB-FONDOS\functions_python\services\optimizer.py", `
  "c:\Users\oanti\Documents\BDB-FONDOS\functions_python\services\data_fetcher.py", `
  "c:\Users\oanti\Documents\BDB-FONDOS\functions_python\services\config.py", `
  "c:\Users\oanti\Documents\BDB-FONDOS\functions_python\main.py", `
  "c:\Users\oanti\Documents\BDB-FONDOS\frontend\src\hooks\usePortfolioActions.ts", `
  "c:\Users\oanti\Documents\BDB-FONDOS\frontend\src\components\modals\SharpeMaximizerModal.tsx", `
  "c:\Users\oanti\Documents\BDB-FONDOS\frontend\src\components\modals\TacticalModal.tsx", `
  "c:\Users\oanti\Documents\BDB-FONDOS\frontend\src\utils\rulesEngine.ts", `
  "c:\Users\oanti\Documents\BDB-FONDOS\frontend\src\utils\statistics.ts" `
  -DestinationPath "c:\Users\oanti\Documents\BDB-FONDOS\logica_seleccion_sharpe.zip" -Force</pre>
</div>

<p style="margin-top:40px;font-size:11px;color:#94a3b8;text-align:center;border-top:1px solid #e2e8f0;padding-top:20px;">
  BDB-FONDOS ‚Äî Documentaci√≥n T√©cnica Interna | Generado el 20 Febrero 2026
</p>

</body>
</html>
