<!DOCTYPE html>
<html lang="es">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Pensión</title>
    <!-- Tailwind CSS para un diseño moderno y adaptable -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <!-- html2pdf.js para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            background: #ffffff;
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid #3b82f6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-top: -8px;
        }

        input[type=range]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            background: #ffffff;
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid #3b82f6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .renta-type-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #2563eb;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }

        /* PDF OPTIMIZATION & MODERN STYLE */
        #view-planning.pdf-mode {
            padding: 20px !important;
            font-family: 'Inter', sans-serif !important;
            color: #1f2937 !important;
            background: white !important;
        }

        #view-planning.pdf-mode h2 {
            font-size: 22px !important;
            color: #1e40af !important;
            /* Dark Blue */
            margin-bottom: 15px !important;
            text-transform: uppercase;
            letter-spacing: -0.02em;
        }

        #view-planning.pdf-mode h3 {
            font-size: 14px !important;
            color: #4b5563 !important;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 4px;
            margin-bottom: 8px !important;
            font-weight: 700 !important;
        }

        #view-planning.pdf-mode .grid {
            display: grid !important;
            gap: 10px !important;
        }

        #view-planning.pdf-mode .p-4 {
            padding: 8px 12px !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 6px !important;
            background: #f9fafb !important;
            box-shadow: none !important;
        }

        #view-planning.pdf-mode .text-2xl {
            font-size: 16px !important;
        }

        #view-planning.pdf-mode .text-xs {
            font-size: 9px !important;
        }

        #view-planning.pdf-mode .mb-8 {
            margin-bottom: 12px !important;
        }

        /* Table Optimization */
        #view-planning.pdf-mode table {
            font-size: 9px !important;
            width: 100%;
            border-collapse: collapse;
        }

        #view-planning.pdf-mode th {
            background-color: #f3f4f6 !important;
            color: #111827 !important;
            padding: 4px !important;
        }

        #view-planning.pdf-mode td {
            padding: 4px !important;
            border-bottom: 1px solid #f3f4f6;
        }

        #view-planning.pdf-mode tr.pdf-hide {
            display: none !important;
        }

        /* Chart Resize */
        #view-planning.pdf-mode canvas {
            max-height: 220px !important;
            width: 100% !important;
        }

        /* Legal Disclaimer */
        #view-planning.pdf-mode .bg-yellow-50 {
            background-color: #fffbeb !important;
            border: 1px solid #fcd34d !important;
            padding: 8px !important;
        }

        /* Ocultar Panel Izquierdo (Captura) en PDF */
        #view-planning.pdf-mode .glass-panel {
            display: none !important;
        }



        /* Estilos Captura 2: Barra Fiscal (PDF) */
        #view-planning.pdf-mode .fiscal-bar-capture {
            width: 50% !important;
            /* Mitad de tamaño */
            margin: 0 auto !important;
            height: 10px !important;
            /* Altura reducida a la mitad */
            line-height: 10px !important;
            /* Centrado vertical */
        }

        #view-planning.pdf-mode .fiscal-bar-capture .text-xs {
            font-size: 5px !important;
            /* Texto diminuto para caer bien */
            line-height: 10px !important;
        }

        /* Ajustar Grid para ocupar todo el ancho */
        #view-planning.pdf-mode .grid {
            display: block !important;
        }

        #view-planning.pdf-mode .grid>div {
            width: 100% !important;
            max-width: 100% !important;
        }

        /* Centrar contenido restante */
        #view-planning.pdf-mode #informeFinalBody .grid-cols-1.md\:grid-cols-3 {
            display: flex !important;
            justify-content: center !important;
            gap: 15px !important;
        }

        #view-planning.pdf-mode #informeFinalBody .grid-cols-1.md\:grid-cols-3>div {
            flex: 1 !important;
            text-align: center !important;
        }




        .renta-type-btn {
            transition: all 0.2s ease-in-out;
        }

        .rescate-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #1d4ed8;
        }

        .rescate-btn {
            transition: all 0.15s ease;
        }

        /* Estilos para el Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
            transform: translateX(100%);
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #3b82f6;
        }

        .plan-toggle-btn.active {
            background-color: #ffffff;
            color: #1f2937;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Shared Styles */
        .hidden {
            display: none !important;
        }

        /* Plan Page Specific Styles */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.1);
        }

        .input-group label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.5rem;
            display: block;
        }

        .input-group input {
            transition: all 0.2s;
        }

        .input-group input:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2);
        }

        /* Existing Styles from Main */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            background: #ffffff;
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid #3b82f6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-top: -8px;
        }

        input[type=range]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            background: #ffffff;
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid #3b82f6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .renta-type-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .renta-type-btn {
            transition: all 0.2s ease-in-out;
        }

        .rescate-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #1d4ed8;
        }

        .rescate-btn {
            transition: all 0.15s ease;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
            transform: translateX(100%);
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #3b82f6;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <!-- VIEW: MAIN CALCULATOR -->
    <div id="view-main" class="p-4 sm:p-6 md:p-8 flex items-center justify-center min-h-screen">


        <div class="w-full max-w-6xl mx-auto">
            <!-- Título Principal -->
            <div class="text-center mb-8">
                <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 tracking-tight">Calculadora de Pensión</h1>
                <p class="text-gray-600 mt-4 text-2xl">Estima tu renta mensual durante la jubilación.</p>
            </div>

            <!-- Calculadora Principal -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden md:grid md:grid-cols-2">
                <!-- Columna de Entradas (Izquierda) -->
                <div class="p-6 md:p-8 space-y-6 flex flex-col">
                    <div class="flex-grow">
                        <!-- Selector de Tipo de Renta -->
                        <div>
                            <label class="font-semibold text-gray-700 block mb-3 text-lg">1. Elige el tipo de
                                renta</label>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                <button id="btnTemporal"
                                    class="renta-type-btn w-full py-3 px-2 border border-gray-300 rounded-lg font-semibold active text-base">Temporal</button>
                                <button id="btnVitaliciaSostenible"
                                    class="renta-type-btn w-full py-3 px-2 border border-gray-300 rounded-lg font-semibold text-base">Vitalicia
                                    (Sostenible)</button>
                                <button id="btnVitaliciaEV"
                                    class="renta-type-btn w-full py-3 px-2 border border-gray-300 rounded-lg font-semibold text-base">Vitalicia
                                    (Esperanza Vida)</button>
                            </div>
                        </div>

                        <!-- Formulario de Inputs Dinámico -->
                        <div class="space-y-6 mt-6">
                            <div>
                                <label for="ahorrosJubilacion" class="font-semibold text-gray-700 text-base">2. Ahorros
                                    para
                                    la Jubilación (€)</label>
                                <input type="number" id="ahorrosJubilacion" value="0"
                                    class="w-full mt-2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-xl"
                                    placeholder="Ej: 300000">
                            </div>
                            <div>
                                <label for="revalorizacionAnual"
                                    class="flex justify-between font-semibold text-gray-700 text-base">
                                    <span>3. Revalorización Anual de Ahorros (%)</span>
                                    <span id="revalorizacionAnualVal"
                                        class="font-bold text-blue-600 text-lg">3.0%</span>
                                </label>
                                <input type="range" id="revalorizacionAnual" min="0" max="15" value="0" step="0.1"
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
                            </div>

                            <!-- Configuración EPSV -->
                            <div class="p-5 bg-blue-50/50 rounded-xl border border-blue-100">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="font-bold text-gray-800 text-lg">Configuración EPSV</label>
                                    <span
                                        class="text-xs font-medium px-2 py-1 bg-blue-100 text-blue-700 rounded-full">Opcional</span>
                                </div>

                                <div class="mb-5 grid grid-cols-2 gap-3">
                                    <div>
                                        <label for="ahorrosEPSV"
                                            class="text-sm font-semibold text-gray-600 block mb-1">Total EPSV
                                            (€)</label>
                                        <input type="number" id="ahorrosEPSV" value="0"
                                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg transition"
                                            placeholder="0">
                                    </div>
                                    <div>
                                        <label for="beneficioEPSV"
                                            class="text-sm font-semibold text-gray-600 block mb-1">Beneficio (€)</label>
                                        <input type="number" id="beneficioEPSV" value="0"
                                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 text-lg transition"
                                            placeholder="0">
                                        <p class="text-[10px] text-gray-400 mt-1">Beneficio acumulado incluido en el
                                            total.
                                        </p>
                                    </div>
                                </div>

                                <div id="opcionesRescateEPSV" class="space-y-3">
                                    <label class="text-sm font-semibold text-gray-600 block">Modalidad de Rescate EPSV
                                        preferida</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button id="btnRescateRenta"
                                            class="rescate-btn active w-full py-2 border border-gray-300 bg-white rounded-lg text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Renta</button>
                                        <button id="btnRescateCapital"
                                            class="rescate-btn w-full py-2 border border-gray-300 bg-white rounded-lg text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Capital</button>
                                        <button id="btnRescateMixto"
                                            class="rescate-btn w-full py-2 border border-gray-300 bg-white rounded-lg text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Mixto</button>
                                    </div>

                                    <!-- Slider para Mixto (Oculto por defecto) -->
                                    <div id="sliderMixtoContainer"
                                        class="hidden mt-3 p-3 bg-white rounded-lg border border-gray-200">
                                        <label class="flex justify-between text-xs font-bold text-gray-700 mb-2">
                                            <span>% Rescatado en Capital (con reducción 40%)</span>
                                            <span id="porcentajeCapitalVal" class="text-blue-600">50%</span>
                                        </label>
                                        <input type="range" id="porcentajeCapital" min="0" max="100" value="50"
                                            class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                                    </div>
                                </div>
                            </div>

                            <!-- Ahorro Total (calculado) -->
                            <div class="p-4 bg-green-50 rounded-xl border border-green-200">
                                <div class="flex items-center justify-between">
                                    <label class="font-bold text-green-800 text-base">Ahorro Total para Renta</label>
                                    <span id="ahorroTotalDisplay" class="text-xl font-extrabold text-green-700">0,00
                                        €</span>
                                </div>
                                <p class="text-[10px] text-green-600 mt-1">= Ahorros Jubilación + EPSV (tras rescate en
                                    capital, si aplica)</p>
                            </div>

                            <!-- Campos para Renta Temporal -->
                            <div id="camposTemporal" class="space-y-6">
                                <div>
                                    <label for="aniosCobro"
                                        class="flex justify-between font-semibold text-gray-700 text-base">
                                        <span>4. Años de Cobro de la Renta</span>
                                        <span id="aniosCobroVal" class="font-bold text-blue-600 text-lg">25 años</span>
                                    </label>
                                    <input type="range" id="aniosCobro" min="1" max="50" value="25"
                                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
                                </div>
                                <div>
                                    <label for="actualizacionAnual"
                                        class="flex justify-between font-semibold text-gray-700 text-base">
                                        <span>5. Actualización Anual de la Renta (%)</span>
                                        <span id="actualizacionAnualVal"
                                            class="font-bold text-blue-600 text-lg">1.0%</span>
                                    </label>
                                    <input type="range" id="actualizacionAnual" min="0" max="10" value="0" step="0.1"
                                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
                                </div>
                            </div>

                            <!-- Campos para Esperanza de Vida -->
                            <div id="camposEsperanzaVida" class="hidden space-y-6">
                                <div>
                                    <label for="edadActual" class="font-semibold text-gray-700 text-base">4. Edad
                                        Actual</label>
                                    <input type="number" id="edadActual" value="65"
                                        class="w-full mt-2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-xl"
                                        placeholder="Ej: 65">
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-700 block mb-2 text-base">5. Sexo</label>
                                    <select id="sexo"
                                        class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-lg">
                                        <option value="male">Hombre</option>
                                        <option value="female">Mujer</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="actualizacionAnualEV"
                                        class="flex justify-between font-semibold text-gray-700 text-base">
                                        <span>6. Actualización Anual de la Renta (%)</span>
                                        <span id="actualizacionAnualValEV"
                                            class="font-bold text-blue-600 text-lg">1.0%</span>
                                    </label>
                                    <input type="range" id="actualizacionAnualEV" min="0" max="10" value="0" step="0.1"
                                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
                                </div>
                            </div>
                        </div>
                        <p id="errorMensaje" class="text-red-500 text-center mt-4 font-medium h-5"></p>
                    </div>


                </div>

                <!-- Columna de Resultados (Derecha) -->
                <div
                    class="bg-gradient-to-br from-blue-600 to-blue-500 text-white p-8 flex flex-col items-center justify-center">
                    <div class="w-full max-w-md text-center">
                        <!-- Título dinámico de resultados -->
                        <h2 id="resultadoTitulo" class="text-3xl font-bold mb-6"></h2>

                        <!-- Resultado Rescate Capital EPSV (Nuevo) -->
                        <div id="resultadoCapitalEPSV" class="hidden mb-6 w-full animate-fade-in-down">
                            <div
                                class="bg-white/10 backdrop-blur-md border border-white/20 rounded-xl p-4 w-full max-w-sm mx-auto shadow-lg transform transition-all hover:scale-105">
                                <h3 class="text-sm font-bold uppercase tracking-wider opacity-90 text-yellow-300 mb-1">
                                    Capital Neto Inmediato (EPSV)</h3>
                                <p id="capitalNetoEPSV" class="text-4xl font-extrabold tracking-tight text-white mb-2">
                                    €0
                                </p>
                                <p class="text-xs text-blue-100 opacity-80 leading-relaxed">
                                    Este importe se cobra al inicio en un pago único (tras impuestos est.). <br>
                                    <strong>El resto de tu ahorro genera la renta mensual abajo.</strong>
                                </p>
                            </div>
                        </div>

                        <!-- Resultado para Renta Temporal y Vitalicia EV -->
                        <div id="resultadoTemporalEV">
                            <div class="space-y-4">
                                <div class="bg-black/20 backdrop-blur-sm rounded-xl p-3 w-2/3 mx-auto">
                                    <h3 class="text-lg font-medium opacity-80">Renta Privada Inicial</h3>
                                    <p id="rentaInicial" class="text-3xl font-bold tracking-tight mt-1">€0</p>
                                </div>
                                <div class="bg-black/20 backdrop-blur-sm rounded-xl p-3 w-2/3 mx-auto">
                                    <h3 class="text-lg font-medium opacity-80">Renta Privada Final</h3>
                                    <p id="rentaFinal" class="text-3xl font-bold tracking-tight mt-1">€0</p>
                                </div>
                            </div>
                        </div>
                        <!-- Resultado para Renta Vitalicia Sostenible -->
                        <div id="resultadoVitaliciaSostenible" class="hidden">
                            <div class="bg-black/20 backdrop-blur-sm rounded-xl p-3 w-2/3 mx-auto">
                                <h3 class="text-lg font-medium opacity-80">Renta Privada Mensual</h3>
                                <p id="rentaVitalicia" class="text-3xl font-bold tracking-tight mt-1">€0</p>
                            </div>
                        </div>

                        <!-- Botón para Planificación Completa -->
                        <button id="btnPlanCompleta"
                            class="mt-8 w-full bg-white text-blue-600 font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-gray-100 transition transform hover:scale-105 flex items-center justify-center gap-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                                </path>
                            </svg>
                            PLANIFICACIÓN COMPLETA
                        </button>
                        <p class="text-xs text-blue-100 mt-3 text-center opacity-90 italic">
                            * Si deseas conocer tu pensión total (incluyendo la pública) y el resumen fiscal de tu
                            pensión
                            final, pulsa aquí.
                        </p>
                    </div>


                </div>
            </div>



            <!-- Tabla de Desglose Anual -->
            <div id="tabla-container" class="mt-8 bg-white rounded-2xl shadow-xl p-6 md:p-8 hidden">
                <h2 id="tabla-titulo" class="text-3xl font-bold text-gray-800 mb-6 text-center"></h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-base">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-center font-semibold text-gray-600 tracking-wider">Año</th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 tracking-wider">Renta
                                    Mensual
                                </th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 tracking-wider">Balance
                                    Inicial
                                </th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 tracking-wider">Balance
                                    Final
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tabla-cuerpo" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>


    </div>

    <!-- VIEW: PLANNING (Hidden by default) -->
    <div id="view-planning"
        class="hidden min-h-screen p-4 md:p-8 flex justify-center items-start bg-gradient-to-br from-gray-100 to-gray-200">

        <div class="max-w-4xl w-full mx-auto">

            <!-- Header con Botón Volver y PDF -->
            <div class="mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
                <a href="#" id="btnVolverMain"
                    class="flex items-center text-blue-600 hover:text-blue-800 font-semibold transition">
                    <i class="fas fa-arrow-left mr-2"></i> Volver a la Calculadora
                </a>
                <div class="flex items-center gap-3">
                    <button id="btnDescargarPDF"
                        class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow transition flex items-center">
                        <i class="fas fa-file-pdf mr-2"></i> Descargar PDF
                    </button>
                    <h1 class="text-2xl font-bold text-gray-800">Planificación Completa</h1>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

                <!-- Panel Izquierdo: Datos Generales -->
                <div class="glass-panel rounded-2xl p-6 md:p-8 space-y-6">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-3 border-gray-200">
                        <i class="fas fa-sliders-h mr-2 text-blue-500"></i> Integración Pensión Pública
                    </h2>

                    <!-- Renta Privada (Solo Lectura) -->
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <label class="block text-sm font-semibold text-blue-700 mb-1">Tu Renta Privada
                            (Calculada)</label>
                        <div class="flex items-baseline">
                            <span id="displayRentaPrivada" class="text-3xl font-bold text-blue-900">€0,00</span>
                            <span class="ml-2 text-sm text-blue-600">/mes</span>
                        </div>
                        <p class="text-xs text-blue-500 mt-1">
                            <i class="fas fa-info-circle"></i> Parte exenta de impuestos: <span id="displayParteExenta"
                                class="font-bold">0%</span>
                        </p>
                    </div>

                    <!-- Input Pensión Pública -->
                    <div class="input-group">
                        <label for="pensionPublica" class="flex items-center text-lg font-bold text-gray-800 mb-2">
                            <i class="fas fa-plus-circle text-green-500 mr-2"></i> Añadir Pensión Pública (Mensual)
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">€</span>
                            <input type="number" id="pensionPublica"
                                class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-lg"
                                placeholder="Ej: 1500" value="0">
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Introduce el importe neto o bruto según referencia
                            (cálculo
                            asume integración en base imponible).</p>
                        <a href="https://sede-tu.seg-social.gob.es/" target="_blank" rel="noopener noreferrer"
                            class="flex items-center text-xs text-blue-500 hover:text-blue-700 mt-2 font-medium transition-colors">
                            <i class="fas fa-external-link-alt mr-1"></i>
                            SI DESCONOCES TU PENSIÓN PÚBLICA, PUEDES ACCEDER AL SIMULADOR OFICIAL DE LA SEGURIDAD SOCIAL
                        </a>
                    </div>

                </div>

                <!-- Panel Derecho: Resultado Final -->
                <div
                    class="glass-panel rounded-2xl p-6 md:p-8 bg-gradient-to-br from-indigo-600 to-blue-600 text-white flex flex-col justify-center text-center">
                    <h2 class="text-2xl font-bold mb-2">Total Neto Mensual</h2>
                    <p class="text-sm text-blue-100 mb-4 opacity-80 uppercase tracking-widest">Disponible para gastar
                    </p>

                    <div
                        class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20 mb-4 relative overflow-hidden group">
                        <div
                            class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition duration-500">
                        </div>
                        <span id="totalNetoMensual"
                            class="text-5xl md:text-6xl font-extrabold tracking-tight relative z-10 transition-all duration-300">
                            €0
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-3 text-left mb-3">
                        <div class="bg-black/20 rounded-lg p-3">
                            <span class="block text-xs text-blue-200">Bruto Mensual</span>
                            <span id="brutoMensual" class="block text-lg font-bold">€0</span>
                        </div>
                        <div class="bg-black/20 rounded-lg p-3">
                            <span class="block text-xs text-blue-200">Neto Anual</span>
                            <span id="netoAnual" class="block text-lg font-bold">€0</span>
                        </div>
                        <div class="bg-black/20 rounded-lg p-3">
                            <span class="block text-xs text-blue-200">Total Bruto Anual</span>
                            <span id="totalBrutoAnual" class="block text-lg font-bold">€0</span>
                        </div>
                        <div class="bg-black/20 rounded-lg p-3">
                            <span class="block text-xs text-blue-200">IRPF Anual</span>
                            <span id="totalImpuestos" class="block text-lg font-bold text-red-200">€0</span>
                        </div>
                    </div>

                    <!-- Tipo Medio Efectivo -->
                    <div class="bg-black/30 rounded-lg p-3 mb-3">
                        <span class="block text-xs text-blue-200">Tipo Medio Efectivo</span>
                        <span id="tipoMedioEfectivo" class="block text-2xl font-extrabold text-yellow-300">0,0%</span>
                    </div>

                    <!-- Desglose EPSV -->
                    <div id="desgloseEPSV" class="hidden bg-black/20 rounded-lg p-3 text-left space-y-1">
                        <span class="block text-xs text-blue-200 font-bold uppercase tracking-wider">Desglose EPSV (Art.
                            37.e)</span>
                        <div class="flex justify-between text-sm">
                            <span class="text-green-300">Parte Exenta (Rentabilidad)</span>
                            <span id="parteExentaAnual" class="font-bold text-green-300">€0</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-orange-200">Parte Sujeta RT (Principal)</span>
                            <span id="parteSujetaAnual" class="font-bold text-orange-200">€0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INFORME PLANIFICACIÓN FINAL -->
            <div id="informeFinalContainer" class="hidden mt-8 bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="bg-gradient-to-r from-indigo-700 to-blue-600 p-6 text-white">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <i class="fas fa-file-invoice-dollar"></i> Informe de Planificación Final
                    </h2>
                    <p class="text-sm text-blue-100 mt-1 opacity-80">Norma Foral 2/2025 · Ejercicio 2026 · Bizkaia</p>
                </div>
                <div id="informeFinalBody" class="p-6 md:p-8 space-y-8">
                    <!-- Populated by JS -->
                </div>
            </div>

        </div>



    </div>

    <script>
        // --- SHARED GLOBALS ---
        let currentRentaPrivadaInicial = 0;  // Renta privada mensual calculada
        let currentRatioExento = 0;           // coef_exento EPSV (Art. 37.e)
        let currentEpsvParaRenta = 0;         // Porción del capital para renta que proviene de EPSV
        let currentCapitalParaRenta = 0;      // Capital total destinado a renta
        let currentAnios = 0;                 // Plazo de la renta en años
        let currentRevalorizacion = 0;        // Tipo de interés de revalorización del capital
        let currentActualizacion = 0;         // Crecimiento anual de la renta
        const currencyFormatter = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' });
        const pctFormatter = new Intl.NumberFormat('es-ES', { style: 'percent', minimumFractionDigits: 1, maximumFractionDigits: 1 });

        // --- BIZKAIA TAX ENGINE (NF 2/2025 — Ejercicio 2026) ---
        // --- HELPER FUNCTIONS FOR FISCAL LOGIC ---
        const getBonificacionTrabajo = (rendimientoNeto) => {
            // Tabla de bonificaciones (aprox. basada en normativa general previa + ajuste 2026)
            if (rendimientoNeto <= 7500) return 8000;
            // Se mantiene una reducción decreciente simplificada para el ejemplo
            // En producción real, usar tabla exacta NF 2/2025 Art 18
            if (rendimientoNeto > 7500 && rendimientoNeto <= 23000) {
                return 8000 - ((rendimientoNeto - 7500) * 0.25); // Decrecimiento suave
            }
            return 0; // Sin bonificación para rentas altas
        };

        const getMinoracionCuota = () => {
            return 1615; // Minoración fija Bizkaia 2026 (Art. 77)
        };

        // --- BIZKAIA TAX ENGINE (NF 2/2025 — Ejercicio 2026) ---
        const calculateBizkaiaTax = (income) => {
            if (income <= 0) return 0;

            // 1. Bonificación Rendimientos del Trabajo (Art. 18 NF 2/2025)
            const bonificacion = getBonificacionTrabajo(income);
            const baseLiquidable = Math.max(0, income - bonificacion);

            const brackets = [
                { limit: 208390, rate: 0.49 },
                { limit: 142960, rate: 0.47 },
                { limit: 107260, rate: 0.46 },
                { limit: 77450, rate: 0.45 },
                { limit: 54240, rate: 0.40 },
                { limit: 36160, rate: 0.35 },
                { limit: 18080, rate: 0.28 },
                { limit: 0, rate: 0.23 }
            ];
            let tax = 0;
            let remainingIncome = baseLiquidable;
            for (const bracket of brackets) {
                if (remainingIncome > bracket.limit) {
                    tax += (remainingIncome - bracket.limit) * bracket.rate;
                    remainingIncome = bracket.limit;
                }
            }

            // Minoración de cuota (Art. 77 NF 2/2025)
            const minoracion = getMinoracionCuota();
            tax = Math.max(0, tax - minoracion);

            return tax;
        };

        // --- MAIN PAGE LOGIC ---

        // --- ELEMENTOS DEL DOM ---
        const ahorrosInput = document.getElementById('ahorrosJubilacion');
        const revalorizacionInput = document.getElementById('revalorizacionAnual');
        const btnTemporal = document.getElementById('btnTemporal');
        const btnVitaliciaSostenible = document.getElementById('btnVitaliciaSostenible');
        const btnVitaliciaEV = document.getElementById('btnVitaliciaEV');

        const rentaInicialEl = document.getElementById('rentaInicial');
        const rentaFinalEl = document.getElementById('rentaFinal');
        const rentaVitaliciaEl = document.getElementById('rentaVitalicia');
        const errorMensajeEl = document.getElementById('errorMensaje');
        const resultadoTitulo = document.getElementById('resultadoTitulo');

        const camposTemporal = document.getElementById('camposTemporal');
        const camposEsperanzaVida = document.getElementById('camposEsperanzaVida');
        const resultadoTemporalEV = document.getElementById('resultadoTemporalEV');
        const resultadoVitaliciaSostenible = document.getElementById('resultadoVitaliciaSostenible');

        const aniosInput = document.getElementById('aniosCobro');
        const actualizacionInput = document.getElementById('actualizacionAnual');
        const aniosVal = document.getElementById('aniosCobroVal');
        const actualizacionVal = document.getElementById('actualizacionAnualVal');

        const edadActualInput = document.getElementById('edadActual');
        const sexoInput = document.getElementById('sexo');
        const actualizacionInputEV = document.getElementById('actualizacionAnualEV');
        const actualizacionValEV = document.getElementById('actualizacionAnualValEV');

        const tablaContainer = document.getElementById('tabla-container');
        const tablaCuerpo = document.getElementById('tabla-cuerpo');
        const tablaTitulo = document.getElementById('tabla-titulo');
        const revalorizacionVal = document.getElementById('revalorizacionAnualVal');

        const btnPlanCompleta = document.getElementById('btnPlanCompleta');

        // --- ELEMENTOS EPSV ---
        const ahorrosEPSVInput = document.getElementById('ahorrosEPSV');
        const beneficioEPSVInput = document.getElementById('beneficioEPSV');
        const btnRescateRenta = document.getElementById('btnRescateRenta');
        const btnRescateCapital = document.getElementById('btnRescateCapital');
        const btnRescateMixto = document.getElementById('btnRescateMixto');
        const sliderMixtoContainer = document.getElementById('sliderMixtoContainer');
        const porcentajeCapitalInput = document.getElementById('porcentajeCapital');
        const porcentajeCapitalVal = document.getElementById('porcentajeCapitalVal');
        const resultadoCapitalEPSV = document.getElementById('resultadoCapitalEPSV');
        const capitalNetoEPSVEl = document.getElementById('capitalNetoEPSV');

        // --- ELEMENTOS SPA (Planificación) ---
        const viewMain = document.getElementById('view-main');
        const viewPlanning = document.getElementById('view-planning');
        const pensionInput = document.getElementById('pensionPublica');
        const displayRenta = document.getElementById('displayRentaPrivada');
        const displayExento = document.getElementById('displayParteExenta');
        const totalNetoEl = document.getElementById('totalNetoMensual');
        const totalBrutoEl = document.getElementById('totalBrutoAnual');
        const totalImpuestosEl = document.getElementById('totalImpuestos');
        const btnVolverMain = document.getElementById('btnVolverMain');

        // --- DATOS ---
        const lifeExpectancyData = {
            50: { male: 32.2, female: 36.6 }, 55: { male: 27.7, female: 32.0 },
            60: { male: 23.3, female: 27.4 }, 65: { male: 19.2, female: 23.0 },
            70: { male: 15.5, female: 18.9 }, 75: { male: 12.1, female: 15.1 },
            80: { male: 9.1, female: 11.7 }, 85: { male: 6.6, female: 8.6 },
            90: { male: 4.6, female: 6.0 }, 95: { male: 3.1, female: 4.0 },
        };
        // const currencyFormatter = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' });

        let rentaType = 'temporal';
        let rescateEPSVMode = 'renta'; // 'renta', 'capital', 'mixto'


        // --- FUNCIONES ---
        function getLifeExpectancy(age, gender) {
            const ageKeys = Object.keys(lifeExpectancyData).map(Number).sort((a, b) => b - a);
            const applicableAge = ageKeys.find(key => age >= key) || Math.min(...ageKeys);
            return lifeExpectancyData[applicableAge]?.[gender] ?? 0;
        }

        function actualizarValoresSliders() {
            aniosVal.textContent = `${aniosInput.value} años`;
            revalorizacionVal.textContent = `${parseFloat(revalorizacionInput.value).toFixed(1)}%`;
            actualizacionVal.textContent = `${parseFloat(actualizacionInput.value).toFixed(1)}%`;
            actualizacionValEV.textContent = `${parseFloat(actualizacionInputEV.value).toFixed(1)}%`;
        }



        /**
         * Coeficiente de exención EPSV (Art. 37.e y 9.38 NF 13/2013)
         * 
         * coef_exento = rentabilidad_acumulada / capital_total_epsv
         * 
         * Este coeficiente es INVARIABLE durante toda la vida de la renta.
         * Para rentas > 15 años, la parte de cada pago correspondiente a
         * la rentabilidad (pago × coef_exento) está 100% exenta.
         * Solo la parte del principal (pago × (1 - coef_exento)) tributa
         * como Rendimiento de Trabajo en la Base General.
         * 
         * @returns {number} coeficiente entre 0 y 1
         */
        function calculateExemptionRatio() {
            const ahorrosEPSV = parseFloat(ahorrosEPSVInput.value) || 0;
            const beneficioEPSV = parseFloat(beneficioEPSVInput.value) || 0;

            if (ahorrosEPSV <= 0 || beneficioEPSV <= 0) return 0;
            if (beneficioEPSV > ahorrosEPSV) return 0; // Datos inválidos

            // coef_exento = rentabilidad / capital_total_epsv
            return beneficioEPSV / ahorrosEPSV;
        }


        function calculateEPSVNetoOneOff(amountEPSV, pensionPublicaAnual) {
            const baseImponibleExtra = amountEPSV * 0.60;
            const taxBase = calculateBizkaiaTax(pensionPublicaAnual);
            const taxTotal = calculateBizkaiaTax(pensionPublicaAnual + baseImponibleExtra);
            const taxIncremental = taxTotal - taxBase;
            return amountEPSV - taxIncremental;
        }

        function actualizarOpcionesRescateEPSV() {
            [btnRescateRenta, btnRescateCapital, btnRescateMixto].forEach(btn => btn.classList.remove('active'));
            if (rescateEPSVMode === 'renta') {
                btnRescateRenta.classList.add('active');
                sliderMixtoContainer.classList.add('hidden');
            } else if (rescateEPSVMode === 'capital') {
                btnRescateCapital.classList.add('active');
                sliderMixtoContainer.classList.add('hidden');
            } else {
                btnRescateMixto.classList.add('active');
                sliderMixtoContainer.classList.remove('hidden');
            }
            calcularYMostrar();
        }

        function calcularYMostrar() {
            errorMensajeEl.textContent = '';
            const ahorrosJubilacion = parseFloat(ahorrosInput.value) || 0;
            const ahorrosEPSV = parseFloat(ahorrosEPSVInput.value) || 0;
            const beneficioEPSV = parseFloat(beneficioEPSVInput.value) || 0;
            const revalorizacion = parseFloat(revalorizacionInput.value) / 100;

            // Reset totals for planning view
            currentRentaPrivadaInicial = 0;
            currentRatioExento = 0;

            // AHORRO TOTAL = Jubilación + EPSV (aditivos)
            const ahorrosTotal = ahorrosJubilacion + ahorrosEPSV;

            if (ahorrosTotal <= 0) {
                errorMensajeEl.textContent = 'Introduce un ahorro inicial positivo.';
                rentaInicialEl.textContent = '---'; rentaFinalEl.textContent = '---'; rentaVitaliciaEl.textContent = '---';
                tablaContainer.classList.add('hidden');
                resultadoCapitalEPSV.classList.add('hidden');
                document.getElementById('ahorroTotalDisplay').textContent = currencyFormatter.format(0);
                return;
            }

            // Validaciones
            if (beneficioEPSV > ahorrosEPSV) {
                errorMensajeEl.textContent = 'El beneficio no puede ser mayor que el total EPSV.';
                beneficioEPSVInput.classList.add('border-red-500');
            } else {
                beneficioEPSVInput.classList.remove('border-red-500');
            }

            // Determinar capital para renta y capital para rescate inmediato
            let capitalParaRenta = ahorrosTotal;
            let capitalRescateInmediato = 0;

            if (ahorrosEPSV > 0) {
                let porcentajeRescate = 0;
                if (rescateEPSVMode === 'capital') porcentajeRescate = 1;
                else if (rescateEPSVMode === 'mixto') porcentajeRescate = parseInt(porcentajeCapitalInput.value) / 100;

                capitalRescateInmediato = ahorrosEPSV * porcentajeRescate;
                capitalParaRenta = ahorrosTotal - capitalRescateInmediato;
            }

            // Mostrar Ahorro Total para Renta
            document.getElementById('ahorroTotalDisplay').textContent = currencyFormatter.format(capitalParaRenta);

            // Mostrar resultado Capital EPSV si aplica
            if (capitalRescateInmediato > 0) {
                const pensionAnual = 0;
                const netoInmediato = calculateEPSVNetoOneOff(capitalRescateInmediato, pensionAnual);
                capitalNetoEPSVEl.textContent = currencyFormatter.format(netoInmediato);
                resultadoCapitalEPSV.classList.remove('hidden');
            } else {
                resultadoCapitalEPSV.classList.add('hidden');
            }

            const ahorros = capitalParaRenta;
            let anios, actualizacion;

            if (rentaType === 'temporal' || rentaType === 'vitaliciaEV') {
                if (rentaType === 'temporal') {
                    anios = parseInt(aniosInput.value);
                    actualizacion = parseFloat(actualizacionInput.value) / 100;
                } else {
                    const edad = parseInt(edadActualInput.value);
                    const sexo = sexoInput.value;
                    if (isNaN(edad) || edad < 50) {
                        errorMensajeEl.textContent = 'Edad debe ser 50 o mayor.'; return;
                    }
                    anios = getLifeExpectancy(edad, sexo);
                    actualizacion = parseFloat(actualizacionInputEV.value) / 100;
                }

                let rentaInicial = 0;
                if (revalorizacion !== actualizacion) {
                    let r_eff = (1 + revalorizacion) / (1 + actualizacion) - 1;
                    if (Math.abs(r_eff) > 1e-9) {
                        rentaInicial = (ahorros * r_eff) / (1 - Math.pow(1 + r_eff, -anios)) / 12;
                    } else { rentaInicial = (ahorros / anios) / 12; }
                } else { rentaInicial = (ahorros / anios) / 12; }

                if (isFinite(rentaInicial) && rentaInicial > 0) {
                    rentaInicialEl.textContent = currencyFormatter.format(rentaInicial);
                    rentaFinalEl.textContent = currencyFormatter.format(rentaInicial * Math.pow(1 + actualizacion, anios - 1));
                    generarYMostrarTabla(rentaInicial, anios, actualizacion, ahorros);
                    currentRentaPrivadaInicial = rentaInicial;
                } else {
                    errorMensajeEl.textContent = 'Parámetros no sostenibles.';
                    rentaInicialEl.textContent = '€0'; rentaFinalEl.textContent = '€0';
                    tablaContainer.classList.add('hidden');
                    currentRentaPrivadaInicial = 0;
                }
            } else { // vitaliciaSostenible
                if (revalorizacion <= 0) {
                    errorMensajeEl.textContent = 'Se necesita revalorización positiva.';
                    rentaVitaliciaEl.textContent = currencyFormatter.format(0);
                    return;
                }
                const rentaVit = (ahorros * revalorizacion) / 12;
                rentaVitaliciaEl.textContent = currencyFormatter.format(rentaVit);
                currentRentaPrivadaInicial = rentaVit;
            }

            // Calcular coeficiente exento y guardar datos para Planificación
            currentRatioExento = calculateExemptionRatio();
            currentCapitalParaRenta = capitalParaRenta;
            currentRevalorizacion = revalorizacion;
            currentActualizacion = (typeof actualizacion !== 'undefined') ? actualizacion : 0;
            currentAnios = (typeof anios !== 'undefined') ? anios : 0;

            // Calcular qué proporción de capitalParaRenta proviene de EPSV
            const epsvEnRenta = ahorrosEPSV - capitalRescateInmediato;
            currentEpsvParaRenta = (capitalParaRenta > 0 && epsvEnRenta > 0)
                ? Math.min(epsvEnRenta / capitalParaRenta, 1)
                : 0;
        }

        function generarYMostrarTabla(rentaInicialMensual, anios, actualizacion, capitalTotal) {
            tablaCuerpo.innerHTML = '';
            if (!isFinite(rentaInicialMensual) || rentaInicialMensual <= 0) {
                tablaContainer.classList.add('hidden'); return;
            }
            const revalorizacion = parseFloat(revalorizacionInput.value) / 100;

            let balance = capitalTotal;
            let rentaMensualActual = rentaInicialMensual;
            const numAnios = Math.floor(anios);

            for (let anio = 1; anio <= numAnios; anio++) {
                const balanceInicialAnio = balance;
                balance = (balance - (rentaMensualActual * 12)) * (1 + revalorizacion);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-center text-gray-700 font-medium">${anio}</td>
                    <td class="px-4 py-3 text-right text-gray-700">${currencyFormatter.format(rentaMensualActual)}</td>
                    <td class="px-4 py-3 text-right text-gray-700">${currencyFormatter.format(balanceInicialAnio)}</td>
                    <td class="px-4 py-3 text-right text-gray-700">${currencyFormatter.format(balance < 0 ? 0 : balance)}</td>
                `;
                tablaCuerpo.appendChild(row);
                rentaMensualActual *= (1 + actualizacion);
            }
            tablaContainer.classList.remove('hidden');
        }



        function actualizarUI() {
            [btnTemporal, btnVitaliciaSostenible, btnVitaliciaEV].forEach(btn => btn.classList.remove('active'));

            if (rentaType === 'temporal') {
                btnTemporal.classList.add('active');
                camposTemporal.style.display = 'block';
                camposEsperanzaVida.style.display = 'none';
                resultadoTemporalEV.classList.remove('hidden');
                resultadoVitaliciaSostenible.classList.add('hidden');
                tablaContainer.classList.remove('hidden');
                resultadoTitulo.textContent = "Renta Temporal";
                tablaTitulo.textContent = "Desglose Anual (Renta Temporal)";
            } else if (rentaType === 'vitaliciaSostenible') {
                btnVitaliciaSostenible.classList.add('active');
                camposTemporal.style.display = 'none';
                camposEsperanzaVida.style.display = 'none';
                resultadoTemporalEV.classList.add('hidden');
                resultadoVitaliciaSostenible.classList.remove('hidden');
                tablaContainer.classList.add('hidden');
                resultadoTitulo.textContent = "Renta Vitalicia (Sostenible)";
            } else { // vitaliciaEV
                btnVitaliciaEV.classList.add('active');
                camposTemporal.style.display = 'none';
                camposEsperanzaVida.style.display = 'block';
                resultadoTemporalEV.classList.remove('hidden');
                resultadoVitaliciaSostenible.classList.add('hidden');
                tablaContainer.classList.remove('hidden');
                const edad = parseInt(edadActualInput.value);
                const aniosEV = getLifeExpectancy(edad, sexoInput.value) || 0;
                resultadoTitulo.textContent = "Renta Vitalicia (Según Esperanza de Vida)";
                tablaTitulo.textContent = `Desglose Anual (hasta ${aniosEV.toFixed(1)} años)`;
            }
            calcularYMostrar();
        }

        // --- EVENT LISTENERS ---
        [ahorrosInput, revalorizacionInput, aniosInput, actualizacionInput, edadActualInput, sexoInput, actualizacionInputEV, ahorrosEPSVInput, beneficioEPSVInput]
            .forEach(input => input.addEventListener('input', () => {
                actualizarValoresSliders();
                actualizarUI();
            }));

        btnRescateRenta.addEventListener('click', () => { rescateEPSVMode = 'renta'; actualizarOpcionesRescateEPSV(); });
        btnRescateCapital.addEventListener('click', () => { rescateEPSVMode = 'capital'; actualizarOpcionesRescateEPSV(); });
        btnRescateMixto.addEventListener('click', () => { rescateEPSVMode = 'mixto'; actualizarOpcionesRescateEPSV(); });

        porcentajeCapitalInput.addEventListener('input', () => {
            porcentajeCapitalVal.textContent = `${porcentajeCapitalInput.value}%`;
            calcularYMostrar();
        });

        btnTemporal.addEventListener('click', () => { rentaType = 'temporal'; actualizarUI(); });
        btnVitaliciaSostenible.addEventListener('click', () => { rentaType = 'vitaliciaSostenible'; actualizarUI(); });
        btnVitaliciaEV.addEventListener('click', () => { rentaType = 'vitaliciaEV'; actualizarUI(); });


        // Listener Boton Plan Completa

        btnPlanCompleta.addEventListener('click', () => {
            // SPA Navigation
            viewMain.classList.add('hidden');
            viewPlanning.classList.remove('hidden');
            initPlanningView();
            window.scrollTo(0, 0);
        });


        // Inicialización
        window.addEventListener('load', () => {
            actualizarValoresSliders();
            actualizarUI();
        });

        function initPlanningView() {
            displayRenta.textContent = currencyFormatter.format(currentRentaPrivadaInicial);
            displayExento.textContent = pctFormatter.format(currentRatioExento);
            calcularPlanificacion();
            generarInformeFinal();
        }

        /**
         * Liquidación IRPF Bizkaia 2026 — Sistema Dual EPSV
         * 
         * 1. Renta Privada Anual = currentRentaPrivadaInicial * 12
         * 2. De esa renta, la proporción que proviene de EPSV → currentEpsvParaRenta
         * 3. Parte EPSV de la renta × coef_exento → 100% EXENTA (renta > 15a)
         * 4. Parte EPSV de la renta × (1 - coef_exento) → RT Base General
         * 5. Parte NO-EPSV de la renta → RT Base General (sin exención)
         * 6. Base General = Pensión Pública + Parte sujeta total
         */


        function calcularPlanificacion() {
            const pensionInput = document.getElementById('pensionPublica');
            const pensionMensual = parseFloat(pensionInput ? pensionInput.value : 0) || 0;

            // --- Cálculos Anuales ---
            const rentaPrivadaAnual = currentRentaPrivadaInicial * 12;
            const pensionPublicaAnual = pensionMensual * 14;  // 14 pagas

            // --- Desglose EPSV ---
            const rentaAnualEPSV = rentaPrivadaAnual * currentEpsvParaRenta;
            const rentaAnualLibre = rentaPrivadaAnual - rentaAnualEPSV;

            // Parte exenta
            const parteExenta = rentaAnualEPSV * currentRatioExento;
            // Parte sujeta
            const parteSujetaEPSV = rentaAnualEPSV * (1 - currentRatioExento);
            const parteSujetaTotal = parteSujetaEPSV + rentaAnualLibre;

            // Base General IRPF (Bruta antes de bonificación)
            const ingresosBrutosIRPF = pensionPublicaAnual + parteSujetaTotal;

            // Cálculo Impuestos
            const impuestoTotal = calculateBizkaiaTax(ingresosBrutosIRPF);

            // Prorateo IRPF (Tipo Medio)
            const tipoMedio = (ingresosBrutosIRPF > 0) ? (impuestoTotal / ingresosBrutosIRPF) : 0;

            // Impuesto atribuible
            const impuestoRentaPrivada = parteSujetaTotal * tipoMedio;
            const impuestoPension = pensionPublicaAnual * tipoMedio;

            // Resultados Finales
            const netoAnualRentaPrivada = rentaPrivadaAnual - impuestoRentaPrivada;
            const netoAnualPension = pensionPublicaAnual - impuestoPension;

            // Total Neto Anual Global
            const totalNetoAnualGlobal = netoAnualRentaPrivada + netoAnualPension;
            const totalNetoMensualGlobal = totalNetoAnualGlobal / 12;

            // Actualizar UI Planificación
            displayRenta.textContent = currencyFormatter.format(currentRentaPrivadaInicial);

            const ratioExentoReal = (rentaPrivadaAnual > 0) ? (parteExenta / rentaPrivadaAnual) : 0;
            displayExento.textContent = pctFormatter.format(ratioExentoReal);

            // Nuevos displays en panel derecho planning
            document.getElementById('totalNetoMensual').textContent = currencyFormatter.format(totalNetoMensualGlobal);
            document.getElementById('brutoMensual').textContent = currencyFormatter.format((rentaPrivadaAnual + pensionPublicaAnual) / 12);
            document.getElementById('netoAnual').textContent = currencyFormatter.format(totalNetoAnualGlobal);
            document.getElementById('totalBrutoAnual').textContent = currencyFormatter.format(rentaPrivadaAnual + pensionPublicaAnual);
            document.getElementById('totalImpuestos').textContent = currencyFormatter.format(impuestoTotal);
            document.getElementById('tipoMedioEfectivo').textContent = pctFormatter.format(tipoMedio);

            // Desglose EPSV panel derecho
            if (currentEpsvParaRenta > 0) {
                document.getElementById('desgloseEPSV').classList.remove('hidden');
                document.getElementById('parteExentaAnual').textContent = currencyFormatter.format(parteExenta);
                document.getElementById('parteSujetaAnual').textContent = currencyFormatter.format(parteSujetaTotal);
            } else {
                document.getElementById('desgloseEPSV').classList.add('hidden');
            }

            // Display Renta Privada en Panel Izquierdo
            document.getElementById('displayRentaPrivada').textContent = currencyFormatter.format(currentRentaPrivadaInicial);
            document.getElementById('displayParteExenta').textContent = pctFormatter.format(currentRatioExento);
        }


        // --- INFORME PLANIFICACION DETALLADO ---
        function generarInformeFinal() {
            const container = document.getElementById('informeFinalBody');
            const pensionInput = document.getElementById('pensionPublica');
            const pensionMensual = parseFloat(pensionInput ? pensionInput.value : 0) || 0;
            const pensionAnual = pensionMensual * 14;
            const rentaPrivadaAnual = currentRentaPrivadaInicial * 12;

            // Recálculo Base para Mostrar Detalles
            const rentaAnualEPSV = rentaPrivadaAnual * currentEpsvParaRenta;
            const rentaAnualLibre = rentaPrivadaAnual - rentaAnualEPSV;
            const parteExenta = rentaAnualEPSV * currentRatioExento;
            const parteSujetaTotal = (rentaAnualEPSV * (1 - currentRatioExento)) + rentaAnualLibre;
            const ingresosBrutosIRPF = pensionAnual + parteSujetaTotal;

            const bonificacion = getBonificacionTrabajo(ingresosBrutosIRPF);
            const baseLiquidable = Math.max(0, ingresosBrutosIRPF - bonificacion);
            const minoracion = getMinoracionCuota();
            const impuestoTotal = calculateBizkaiaTax(ingresosBrutosIRPF);

            const ahorroFiscalEstimado = parteExenta * 0.23; // Conservador

            let html = `
                    <!-- SECCION 1: RESUMEN EJECUTIVO -->

                    <!-- SECCION 1: RESUMEN EJECUTIVO -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Ingresos Totales (Brutos)</h3>
                            <p class="text-2xl font-bold text-gray-900">${currencyFormatter.format(rentaPrivadaAnual + pensionAnual)}</p>
                            <p class="text-xs text-gray-400 mt-1">
                                Pensión: ${currencyFormatter.format(pensionAnual)} | Privado: ${currencyFormatter.format(rentaPrivadaAnual)}
                            </p>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Base Liquidable IRPF</h3>
                            <p class="text-2xl font-bold text-blue-600">${currencyFormatter.format(baseLiquidable)}</p>
                            <p class="text-xs text-blue-400 mt-1">Tras Bonificación Trabajo: -${currencyFormatter.format(bonificacion)}</p>
                        </div>
                         <div class="p-4 bg-green-50 rounded-xl border border-green-200">
                            <h3 class="text-xs font-bold text-green-700 uppercase tracking-widest mb-2">Ahorro Fiscal (EPSV)</h3>
                            <p class="text-2xl font-bold text-green-700">${currencyFormatter.format(ahorroFiscalEstimado)}</p>
                            <p class="text-xs text-green-600 mt-1">Por rentabilidad exenta</p>
                        </div>
                    </div>
    
                    <!-- SECCION 2: DESGLOSE FISCAL (Año 1) -->
                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Desglose Fiscal Detallado (Año 1)</h3>
                        <div class="relative pt-8 pb-4">
                            <div class="flex h-12 rounded-lg overflow-hidden text-xs font-bold text-white shadow-sm fiscal-bar-capture">
                                <div style="width: ${(rentaPrivadaAnual > 0 ? (parteExenta / (rentaPrivadaAnual + pensionAnual) * 100) : 0)}%" class="bg-green-400 flex items-center justify-center relative group">
                                    <span class="truncate px-1">Exento</span>
                                    <div class="absolute bottom-full mb-2 bg-gray-800 text-white p-2 rounded text-xs hidden group-hover:block whitespace-nowrap z-10">
                                        Rentabilidad EPSV Exenta<br>${currencyFormatter.format(parteExenta)}
                                    </div>
                                </div>
                                <div style="width: ${(rentaPrivadaAnual > 0 ? (parteSujetaTotal / (rentaPrivadaAnual + pensionAnual) * 100) : 0)}%" class="bg-orange-400 flex items-center justify-center relative group">
                                    <span class="truncate px-1">Privado Sujeto</span>
                                    <div class="absolute bottom-full mb-2 bg-gray-800 text-white p-2 rounded text-xs hidden group-hover:block whitespace-nowrap z-10">
                                        Privado Sujeto IRPF<br>${currencyFormatter.format(parteSujetaTotal)}
                                    </div>
                                </div>
                                <div style="width: ${(pensionAnual > 0 ? (pensionAnual / (rentaPrivadaAnual + pensionAnual) * 100) : 0)}%" class="bg-blue-400 flex items-center justify-center relative group">
                                    <span class="truncate px-1">Pensión Pública</span>
                                    <div class="absolute bottom-full mb-2 bg-gray-800 text-white p-2 rounded text-xs hidden group-hover:block whitespace-nowrap z-10">
                                        Pensión Pública (Sujeta)<br>${currencyFormatter.format(pensionAnual)}
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-2">
                                 <span>0%</span>
                                 <span class="font-bold text-red-600">Cuota Líquida IRPF: ${currencyFormatter.format(impuestoTotal)} (Minoración ${minoracion}€ aplicada)</span>
                                 <span>100%</span>
                            </div>
                        </div>
                    </div>
    
                    <!-- SECCION 3: TABLA DE PROYECCION -->
                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Proyección Renta Neta (Estimada)</h3>
                        <div class="p-4 bg-white border border-gray-200 rounded-xl max-h-96 overflow-y-auto">
                             <table class="min-w-full text-sm">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-2 py-2 text-left">Año</th>
                                        <th class="px-2 py-2 text-right">Renta Privada</th>
                                        <th class="px-2 py-2 text-right text-blue-600">Pensión Púb.</th>
                                        <th class="px-2 py-2 text-right text-green-600">Parte Exenta</th>
                                        <th class="px-2 py-2 text-right text-orange-600">Base IRPF</th>
                                        <th class="px-2 py-2 text-right text-red-600">Cuota IRPF</th>
                                        <th class="px-2 py-2 text-right font-bold">Neto Mensual</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                `;

            // Generar filas de proyección
            let rentaActual = rentaPrivadaAnual;
            let pensionActual = pensionAnual;
            const ipc = 0.02;
            const crecimientoRenta = currentActualizacion;

            const labels = [];
            const dataExento = [];
            const dataSujeto = [];

            for (let i = 1; i <= Math.min(currentAnios, 30); i++) {
                const parteExenta = rentaActual * currentEpsvParaRenta * currentRatioExento;
                const parteSujeta = rentaActual - parteExenta;
                const ingresosBrutos = pensionActual + parteSujeta;
                const irpfTotal = calculateBizkaiaTax(ingresosBrutos);

                const netoAnual = (rentaActual + pensionActual) - irpfTotal;
                const netoMensual = netoAnual / 12;

                // Lógica de filtrado para PDF (Año 1 y luego cada 5 años)
                const isMilestone = (i === 1 || i % 5 === 0);
                const rowClass = isMilestone ? '' : 'pdf-hide';

                html += `
                        <tr class="${rowClass}">
                            <td class="px-2 py-2 text-gray-900 font-medium">${i}</td>
                             <td class="px-2 py-2 text-right">${currencyFormatter.format(rentaActual)}</td>
                             <td class="px-2 py-2 text-right text-blue-600">${currencyFormatter.format(pensionActual)}</td>
                             <td class="px-2 py-2 text-right text-green-600">${currencyFormatter.format(parteExenta)}</td>
                             <td class="px-2 py-2 text-right text-orange-600">${currencyFormatter.format(ingresosBrutos)}</td>
                             <td class="px-2 py-2 text-right text-red-500">-${currencyFormatter.format(irpfTotal)}</td>
                             <td class="px-2 py-2 text-right font-bold text-gray-900">${currencyFormatter.format(netoMensual)}</td>
                        </tr>
                    `;

                labels.push(`Año ${i}`);
                dataExento.push(parteExenta);
                dataSujeto.push(ingresosBrutos);

                rentaActual *= (1 + crecimientoRenta);
                pensionActual *= (1 + ipc);
            }

            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
    
                    <!-- SECCION 4: GRAFICO -->
                    <div class="mb-4 h-64">
                        <canvas id="chartExentoVsSujeto"></canvas>
                    </div>
    
                    <!-- SECCION 5: NOTAS LEGALES -->
                    <div class="mt-8 p-4 bg-yellow-50 rounded-xl border border-yellow-200 text-xs text-yellow-800">
                        <p class="font-bold mb-1"><i class="fas fa-balance-scale mr-1"></i> Consideraciones Legales:</p>
                        <ul class="list-disc ml-4 space-y-1">
                            <li>Cálculos basados en <strong>Norma Foral 2/2025</strong> (Bizkaia 2026) y <strong>NF 13/2013</strong> (IRPF).</li>
                            <li>Se aplica <strong>Bonificación Rendimientos del Trabajo</strong> y <strong>Minoración de Cuota</strong> (1.615€).</li>
                            <li>Se aplica la <strong>exención total de la rentabilidad EPSV</strong> (Art. 9.38 y 37.e NF 13/2013) para rentas > 15 años.</li>
                            <li>La Pensión Pública se suma íntegramente a la Base General.</li>
                        </ul>
                    </div>
                `;

            container.innerHTML = html;
            document.getElementById('informeFinalContainer').classList.remove('hidden');

            renderChart(labels, dataExento, dataSujeto);
        }

        let chartInstance = null;
        function renderChart(labels, dataExento, dataSujeto) {
            const ctx = document.getElementById('chartExentoVsSujeto').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Parte Exenta (Rentabilidad)',
                            data: dataExento,
                            backgroundColor: '#4ade80',
                            stack: 'Stack 0',
                        },
                        {
                            label: 'Parte Sujeta (Base IRPF)',
                            data: dataSujeto,
                            backgroundColor: '#fb923c',
                            stack: 'Stack 0',
                        },
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                        }
                    }
                }
            });
        }
    </script>
    <script>
        // --- RESTORED MAIN LOGIC & EVENT LISTENERS ---

        // Elementos UI
        const inputs = {
            ahorros: document.getElementById('ahorrosJubilacion'),
            reval: document.getElementById('revalorizacionAnual'),
            epsv: document.getElementById('ahorrosEPSV'),
            beneficio: document.getElementById('beneficioEPSV'),
            anios: document.getElementById('aniosCobro'),
            act: document.getElementById('actualizacionAnual'),
            edad: document.getElementById('edadActual'),
            sexo: document.getElementById('sexo'),
            actEV: document.getElementById('actualizacionAnualEV'),
            pctCapital: document.getElementById('porcentajeCapital')
        };

        const displays = {
            reval: document.getElementById('revalorizacionAnualVal'),
            act: document.getElementById('actualizacionAnualVal'),
            actEV: document.getElementById('actualizacionAnualValEV'),
            anios: document.getElementById('aniosCobroVal'),
            pctCapital: document.getElementById('porcentajeCapitalVal'),
            ahorroTotal: document.getElementById('ahorroTotalDisplay'),
            rentaInicial: document.getElementById('rentaInicial'),
            rentaFinal: document.getElementById('rentaFinal'),
            rentaVitalicia: document.getElementById('rentaVitalicia'),
            resultadoTitulo: document.getElementById('resultadoTitulo'),
            capitalNetoEPSV: document.getElementById('capitalNetoEPSV')
        };

        // Estado UI
        let currentMode = 'temporal'; // temporal, sostenible, ev
        let rescateMode = 'renta';    // renta, capital, mixto

        // Esperanza Vida Simplificada (INE 2024 aprox)
        function getEsperanzaVida(edad, sexo) {
            // Base simple: Mujer 88, 85 - edad... Ajuste básico
            const base = (sexo === 'female') ? 88 : 84;
            return Math.max(1, base - edad);
        }

        // --- UPDATE CALCULATOR ---
        function updateCalculator() {
            // 1. Leer Inputs
            const C_privado = parseFloat(inputs.ahorros.value) || 0;
            const C_epsv_total = parseFloat(inputs.epsv.value) || 0;
            const Beneficio_epsv = parseFloat(inputs.beneficio.value) || 0;
            const i_val = parseFloat(inputs.reval.value) / 100;

            let g_val = 0;
            let n_val = 0;

            // 2. Gestión EPSV según Rescate
            let C_epsv_renta = 0;
            let C_epsv_cash = 0; // Neto de impuestos inmediato

            // Simulación impuestos rescate capital (Tarifa aprox o foral)
            // Aquí simplificamos para UI: mostramos BRUTO rescatado y aviso.
            // O calculamos neto aprox (20%?). En Bizkaia reducción 40% si > 2 años.
            // Asumiremos para el "Capital Neto Inmediato" una retención estimativa del 20% tras reducción.

            if (rescateMode === 'renta') {
                C_epsv_renta = C_epsv_total;
            } else if (rescateMode === 'capital') {
                C_epsv_cash = C_epsv_total; // Todo a cash
            } else if (rescateMode === 'mixto') {
                const pct = parseFloat(inputs.pctCapital.value) / 100;
                C_epsv_cash = C_epsv_total * pct;
                C_epsv_renta = C_epsv_total * (1 - pct);
            }

            // Capital TOTAL para Renta
            const C_total_renta = C_privado + C_epsv_renta;

            // Actualizar Globales para Planificación
            currentCapitalParaRenta = C_total_renta;
            currentRevalorizacion = i_val;

            // Ratio EPSV en la renta (para fiscalidad)
            currentEpsvParaRenta = (C_total_renta > 0) ? (C_epsv_renta / C_total_renta) : 0;

            // Ratio Exento EPSV (Rentabilidad / Total EPSV)
            // Asumimos beneficio proporcional a lo que queda en renta
            currentRatioExento = (C_epsv_total > 0) ? (Beneficio_epsv / C_epsv_total) : 0;


            // 3. Configurar N y G según Modo
            if (currentMode === 'temporal') {
                n_val = parseInt(inputs.anios.value);
                g_val = parseFloat(inputs.act.value) / 100;
            } else if (currentMode === 'ev') {
                const edad = parseInt(inputs.edad.value);
                n_val = Math.floor(getEsperanzaVida(edad, inputs.sexo.value));
                g_val = parseFloat(inputs.actEV.value) / 100;
            } else if (currentMode === 'sostenible') {
                n_val = 100; // Perpetuidad práctica
                g_val = 0;   // Sostenible suele ser nominal constante o C * i
                // Si el usuario quiere Sostenible con crecimiento, es complejo sin descapitalizar.
                // Asumiremos Renta = C * i (Solo Intereses) -> Capital Intacto.
                // O usamos la fórmula con N=100.
            }

            currentAnios = n_val;
            currentActualizacion = g_val;


            // 4. Fórmula Geométrica
            // R1 = (C * (i - g)) / (1 - ((1+g)/(1+i))^N )

            let R1 = 0;

            if (currentMode === 'sostenible') {
                // Renta Perpetua Simple
                R1 = C_total_renta * i_val;
            } else {
                // Geométrica Temporal
                // Validación i != g
                if (Math.abs(i_val - g_val) < 0.0001) {
                    // Indeterminación L'Hopital -> R = C / n  (aprox, sin interés real)
                    // Si i=g, el denominador es 0. 
                    // Formula correcta i=g: R = C / (n / (1+i))? No.
                    // Valor Financiero: C = R * n / (1+i). -> R = C * (1+i) / n.
                    R1 = C_total_renta * (1 + i_val) / n_val;
                } else {
                    const factor = (1 + g_val) / (1 + i_val);
                    const denominador = 1 - Math.pow(factor, n_val);
                    R1 = (C_total_renta * (i_val - g_val)) / denominador;
                }
            }

            // Resultado Anual -> Mensual
            // Asumimos R1 es anual pospagable.
            let mensual = R1 / 12; // 12 pagas estándar en calculadora simple?
            // La Planificación usa 14 pagas si es pensión, pero renta privada suele ser 12.
            // Mantendremos 12 para la UI principal que es más comercial.

            if (mensual < 0) mensual = 0;

            // Actualizar Global Renta (para planificación)
            currentRentaPrivadaInicial = mensual;


            // 5. Update UI Displays
            displays.ahorroTotal.textContent = currencyFormatter.format(C_total_renta);
            displays.reval.textContent = inputs.reval.value + '%';
            displays.act.textContent = inputs.act.value + '%';
            displays.actEV.textContent = inputs.actEV.value + '%';
            displays.anios.textContent = inputs.anios.value + ' años';
            displays.pctCapital.textContent = inputs.pctCapital.value + '%';

            const rnFinal = mensual * Math.pow(1 + g_val, n_val - 1);

            document.getElementById('rentaInicial').textContent = currencyFormatter.format(mensual);
            document.getElementById('rentaFinal').textContent = currencyFormatter.format(rnFinal);
            document.getElementById('rentaVitalicia').textContent = currencyFormatter.format(mensual);

            // Títulos y Visibilidad
            if (currentMode === 'temporal') {
                displays.resultadoTitulo.textContent = `Renta Temporal (${n_val} años)`;
                document.getElementById('resultadoTemporalEV').classList.remove('hidden');
                document.getElementById('resultadoVitaliciaSostenible').classList.add('hidden');
            } else if (currentMode === 'ev') {
                displays.resultadoTitulo.textContent = `Vitalicia (Esperanza ${n_val} años)`;
                document.getElementById('resultadoTemporalEV').classList.remove('hidden');
                document.getElementById('resultadoVitaliciaSostenible').classList.add('hidden');
            } else {
                displays.resultadoTitulo.textContent = `Renta Vitalicia Sostenible`;
                document.getElementById('resultadoTemporalEV').classList.add('hidden');
                document.getElementById('resultadoVitaliciaSostenible').classList.remove('hidden');
            }

            // Rescate EPSV display
            if (rescateMode === 'capital' || rescateMode === 'mixto') {
                document.getElementById('resultadoCapitalEPSV').classList.remove('hidden');
                // Simulamos reducción 40% en Bizkaia si > 2 a os -> Base = 60%. Tipo marginal max 49%.
                // Cash Neto Aprox = Cash * (1 - 0.60 * 0.40) = Cash * 0.76 (ejemplo burdo)
                // Mostraremos el Bruto Rescatado para no confundir
                displays.capitalNetoEPSV.textContent = currencyFormatter.format(C_epsv_cash);
            } else {
                document.getElementById('resultadoCapitalEPSV').classList.add('hidden');
            }

            // Actualizar Tabla si está visible? (Opcional, la tabla inferior)
            updateTabla(monthlyToAnnual(mensual), n_val, g_val, i_val, C_total_renta);
        }

        function monthlyToAnnual(m) { return m * 12; }

        function updateTabla(R1_anual, n, g, i, Capital) {
            const tbody = document.getElementById('tabla-cuerpo');
            const container = document.getElementById('tabla-container');
            const titulo = document.getElementById('tabla-titulo');

            // Mostrar tabla solo si hay renta y años razonables
            if (Capital <= 0 || n <= 0) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');
            titulo.textContent = "Cuadro de Amortización Estimado";

            let html = '';
            let saldo = Capital;
            let cuota = R1_anual;

            // Limit to 50 rows
            const limit = Math.min(n, 50);

            for (let yr = 1; yr <= limit; yr++) {
                // Intereses generados
                const intereses = saldo * i;
                // Capital extraído = Cuota - Intereses
                const amortizado = cuota - intereses; // Ojo, en renta geométrica extraes cuota

                // Saldo Final
                let saldoFinal = saldo + intereses - cuota;

                if (saldoFinal < 0) saldoFinal = 0;

                html += `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-center text-gray-900 border-b">${yr}</td>
                        <td class="px-4 py-3 text-right font-bold text-blue-600 border-b">${currencyFormatter.format(cuota / 12)}</td>
                        <td class="px-4 py-3 text-right text-gray-500 border-b">${currencyFormatter.format(saldo)}</td>
                        <td class="px-4 py-3 text-right text-gray-900 border-b">${currencyFormatter.format(saldoFinal)}</td>
                    </tr>
                `;

                saldo = saldoFinal;
                cuota = cuota * (1 + g);
            }
            tbody.innerHTML = html;
        }


        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Inputs Changes
            Object.values(inputs).forEach(input => {
                if (input) {
                    input.addEventListener('input', updateCalculator);
                    input.addEventListener('change', updateCalculator);
                }
            });

            // 2. Botones Renta
            document.getElementById('btnTemporal').addEventListener('click', () => {
                currentMode = 'temporal';
                setActiveRentaBtn('btnTemporal');
                document.getElementById('camposTemporal').classList.remove('hidden');
                document.getElementById('camposEsperanzaVida').classList.add('hidden');
                updateCalculator();
            });
            document.getElementById('btnVitaliciaSostenible').addEventListener('click', () => {
                currentMode = 'sostenible';
                setActiveRentaBtn('btnVitaliciaSostenible');
                document.getElementById('camposTemporal').classList.add('hidden');
                document.getElementById('camposEsperanzaVida').classList.add('hidden');
                updateCalculator();
            });
            document.getElementById('btnVitaliciaEV').addEventListener('click', () => {
                currentMode = 'ev';
                setActiveRentaBtn('btnVitaliciaEV');
                document.getElementById('camposTemporal').classList.add('hidden');
                document.getElementById('camposEsperanzaVida').classList.remove('hidden');
                updateCalculator();
            });

            // 3. Botones Rescate EPSV
            document.getElementById('btnRescateRenta').addEventListener('click', () => {
                rescateMode = 'renta';
                setActiveRescateBtn('btnRescateRenta');
                document.getElementById('sliderMixtoContainer').classList.add('hidden');
                updateCalculator();
            });
            document.getElementById('btnRescateCapital').addEventListener('click', () => {
                rescateMode = 'capital';
                setActiveRescateBtn('btnRescateCapital');
                document.getElementById('sliderMixtoContainer').classList.add('hidden');
                updateCalculator();
            });
            document.getElementById('btnRescateMixto').addEventListener('click', () => {
                rescateMode = 'mixto';
                setActiveRescateBtn('btnRescateMixto');
                document.getElementById('sliderMixtoContainer').classList.remove('hidden');
                updateCalculator();
            });

            // 4. Planificación Completa (Navigation)
            const viewMain = document.getElementById('view-main');
            const viewPlanning = document.getElementById('view-planning');

            document.getElementById('btnPlanCompleta').addEventListener('click', () => {
                // Trigger calculation before switch
                updateCalculator();
                calcularPlanificacion();
                generarInformeFinal();

                // Animation/Switch
                viewMain.classList.add('hidden');
                viewPlanning.classList.remove('hidden');
                window.scrollTo(0, 0);
            });

            document.getElementById('btnVolverMain').addEventListener('click', (e) => {
                e.preventDefault();
                viewPlanning.classList.add('hidden');
                viewMain.classList.remove('hidden');
            });

            // 5. Input Pensión Pública (Planning View)
            const pensionInput = document.getElementById('pensionPublica');
            if (pensionInput) {
                pensionInput.addEventListener('input', () => {
                    calcularPlanificacion();
                    generarInformeFinal();
                });
            }

            // 6. PDF Export Listener
            const btnPDF = document.getElementById('btnDescargarPDF');
            if (btnPDF) {
                btnPDF.addEventListener('click', generatePDF);
            }

            // Init
            updateCalculator();
        });


        // Helpers
        function setActiveRentaBtn(id) {
            ['btnTemporal', 'btnVitaliciaSostenible', 'btnVitaliciaEV'].forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btnId === id) btn.classList.add('active', 'bg-blue-600', 'text-white');
                else btn.classList.remove('active', 'bg-blue-600', 'text-white');
            });
        }
        function setActiveRescateBtn(id) {
            ['btnRescateRenta', 'btnRescateCapital', 'btnRescateMixto'].forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btnId === id) btn.classList.add('active');
                else btn.classList.remove('active');
            });
        }

        // --- PDF GENERATION ---

        function generatePDF() {
            // Elemento a exportar
            const element = document.getElementById('view-planning');

            // 1. Activar Modo PDF (Estilos simplificados)
            element.classList.add('pdf-mode');

            // Ocultar botones para el PDF
            const botones = element.querySelectorAll('button, a');
            botones.forEach(b => b.style.display = 'none');

            const opt = {
                margin: [5, 10, 5, 10], // Märgenes reducidos top, left, bottom, right
                filename: 'Planificacion_Jubilacion_Bizkaia.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Generar PDF
            html2pdf().set(opt).from(element).save().then(() => {
                // Restaurar estado original
                element.classList.remove('pdf-mode');
                botones.forEach(b => b.style.display = '');
            });
        }

    </script>
</body>

</html>