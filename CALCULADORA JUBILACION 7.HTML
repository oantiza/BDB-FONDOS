<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Pensión</title>
    <!-- Tailwind CSS para un diseño moderno y adaptable -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 22px; height: 22px;
            background: #ffffff; cursor: pointer;
            border-radius: 50%; border: 3px solid #3b82f6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: -8px;
        }
        input[type=range]::-moz-range-thumb {
            width: 22px; height: 22px;
            background: #ffffff; cursor: pointer;
            border-radius: 50%; border: 3px solid #3b82f6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .renta-type-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
         .renta-type-btn {
            transition: all 0.2s ease-in-out;
        }
        /* Estilos para el Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
            transform: translateX(100%);
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
        .plan-toggle-btn.active {
            background-color: #ffffff;
            color: #1f2937;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-6 md:p-8 flex items-center justify-center">

    <div class="w-full max-w-6xl mx-auto">
        <!-- Título Principal -->
        <div class="text-center mb-8">
            <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 tracking-tight">Calculadora de Pensión</h1>
            <p class="text-gray-600 mt-4 text-2xl">Estima tu renta mensual durante la jubilación.</p>
        </div>

        <!-- Calculadora Principal -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden md:grid md:grid-cols-2">
            <!-- Columna de Entradas (Izquierda) -->
            <div class="p-6 md:p-8 space-y-6 flex flex-col">
                <div class="flex-grow">
                    <!-- Selector de Tipo de Renta -->
                    <div>
                        <label class="font-semibold text-gray-700 block mb-3 text-lg">1. Elige el tipo de renta</label>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                            <button id="btnTemporal" class="renta-type-btn w-full py-3 px-2 border border-gray-300 rounded-lg font-semibold active text-base">Temporal</button>
                            <button id="btnVitaliciaSostenible" class="renta-type-btn w-full py-3 px-2 border border-gray-300 rounded-lg font-semibold text-base">Vitalicia (Sostenible)</button>
                            <button id="btnVitaliciaEV" class="renta-type-btn w-full py-3 px-2 border border-gray-300 rounded-lg font-semibold text-base">Vitalicia (Esperanza Vida)</button>
                        </div>
                    </div>

                    <!-- Formulario de Inputs Dinámico -->
                    <div class="space-y-6 mt-6">
                         <div>
                            <label for="ahorrosJubilacion" class="font-semibold text-gray-700 text-base">2. Ahorros para la Jubilación (€)</label>
                            <input type="number" id="ahorrosJubilacion" value="150000" class="w-full mt-2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-xl" placeholder="Ej: 300000">
                        </div>
                         <div>
                             <label for="revalorizacionAnual" class="flex justify-between font-semibold text-gray-700 text-base">
                                <span>3. Revalorización Anual de Ahorros (%)</span>
                                <span id="revalorizacionAnualVal" class="font-bold text-blue-600 text-lg">3.0%</span>
                            </label>
                            <input type="range" id="revalorizacionAnual" min="0" max="15" value="3" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
                        </div>
                        
                        <!-- Campos para Renta Temporal -->
                        <div id="camposTemporal" class="space-y-6">
                            <div>
                                <label for="aniosCobro" class="flex justify-between font-semibold text-gray-700 text-base">
                                    <span>4. Años de Cobro de la Renta</span>
                                    <span id="aniosCobroVal" class="font-bold text-blue-600 text-lg">25 años</span>
                                </label>
                                <input type="range" id="aniosCobro" min="1" max="50" value="25" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
                            </div>
                            <div>
                                <label for="actualizacionAnual" class="flex justify-between font-semibold text-gray-700 text-base">
                                    <span>5. Actualización Anual de la Renta (%)</span>
                                    <span id="actualizacionAnualVal" class="font-bold text-blue-600 text-lg">1.0%</span>
                                </label>
                                <input type="range" id="actualizacionAnual" min="0" max="10" value="1" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
                            </div>
                        </div>

                         <!-- Campos para Esperanza de Vida -->
                        <div id="camposEsperanzaVida" class="hidden space-y-6">
                             <div>
                                <label for="edadActual" class="font-semibold text-gray-700 text-base">4. Edad Actual</label>
                                <input type="number" id="edadActual" value="65" class="w-full mt-2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-xl" placeholder="Ej: 65">
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700 block mb-2 text-base">5. Sexo</label>
                                <select id="sexo" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-lg">
                                    <option value="male">Hombre</option>
                                    <option value="female">Mujer</option>
                                </select>
                            </div>
                             <div>
                                <label for="actualizacionAnualEV" class="flex justify-between font-semibold text-gray-700 text-base">
                                    <span>6. Actualización Anual de la Renta (%)</span>
                                    <span id="actualizacionAnualValEV" class="font-bold text-blue-600 text-lg">1.0%</span>
                                </label>
                                <input type="range" id="actualizacionAnualEV" min="0" max="10" value="1" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
                            </div>
                        </div>
                    </div>
                     <p id="errorMensaje" class="text-red-500 text-center mt-4 font-medium h-5"></p>
                </div>
                
                 <!-- Opción para mostrar planificación completa -->
                <div class="pt-6 border-t border-gray-200">
                    <div class="flex items-center justify-between">
                        <label for="togglePensionPublica" class="font-bold text-gray-800 text-xl">Añadir Pensión Pública</label>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="togglePensionPublica" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-transform duration-200 ease-in-out"/>
                            <label for="togglePensionPublica" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    <p class="text-gray-500 mt-2 text-sm">Marca esta casilla si quieres sumar a tu renta privada tu pensión pública.</p>
                </div>
            </div>

            <!-- Columna de Resultados (Derecha) -->
            <div class="bg-gradient-to-br from-blue-600 to-blue-500 text-white p-8 flex flex-col items-center justify-center">
                <div class="w-full max-w-md text-center">
                    <!-- Título dinámico de resultados -->
                    <h2 id="resultadoTitulo" class="text-3xl font-bold mb-8"></h2>

                    <!-- Resultado para Renta Temporal y Vitalicia EV -->
                    <div id="resultadoTemporalEV">
                        <div class="space-y-4">
                            <div class="bg-black/20 backdrop-blur-sm rounded-xl p-3 w-2/3 mx-auto">
                                <h3 class="text-lg font-medium opacity-80">Renta Privada Inicial</h3>
                                <p id="rentaInicial" class="text-3xl font-bold tracking-tight mt-1">€0</p>
                            </div>
                            <div class="bg-black/20 backdrop-blur-sm rounded-xl p-3 w-2/3 mx-auto">
                                <h3 class="text-lg font-medium opacity-80">Renta Privada Final</h3>
                                <p id="rentaFinal" class="text-3xl font-bold tracking-tight mt-1">€0</p>
                            </div>
                        </div>
                    </div>
                     <!-- Resultado para Renta Vitalicia Sostenible -->
                    <div id="resultadoVitaliciaSostenible" class="hidden">
                        <div class="bg-black/20 backdrop-blur-sm rounded-xl p-3 w-2/3 mx-auto">
                            <h3 class="text-lg font-medium opacity-80">Renta Privada Mensual</h3>
                            <p id="rentaVitalicia" class="text-3xl font-bold tracking-tight mt-1">€0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Apartado Combinado de Pensión Pública (Oculto por defecto) -->
        <div id="planificacionCompletaContainer" class="mt-8 bg-white rounded-2xl shadow-xl p-6 md:p-10 hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-10 text-center">Planificación Completa: Renta Privada + Pensión Pública</h2>
            <div class="md:grid md:grid-cols-2 md:gap-6 items-center">
                <!-- Columna Izquierda: Simulador Oficial -->
                <div class="text-center mb-8 md:mb-0">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-2">1. Calcula tu Pensión Pública</h3>
                    <p class="text-gray-600 mb-5 text-base">
                        Si no conoces tu pensión pública oficial, puedes estimarla en el <strong>Simulador de la Seguridad Social</strong>.
                    </p>
                    <a href="https://prestaciones.seg-social.es/simulador-servicio/simulador-pension-jubilacion.html" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="inline-block bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300 transform hover:scale-105 text-lg">
                        Ir al Simulador Oficial
                    </a>
                </div>
                
                <!-- Columna Derecha: Sumar y Ver Total -->
                <div class="text-center">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-2">2. Suma tu Pensión Pública</h3>
                    <p class="text-gray-600 mb-4 text-base">
                        Introduce la cantidad para obtener el total.
                    </p>
                    <div class="mb-4">
                        <label for="pensionPublicaInput" class="font-semibold text-gray-700 text-lg">Pensión Pública Mensual (€)</label>
                        <input type="number" id="pensionPublicaInput" class="w-1/2 mx-auto mt-4 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-xl" placeholder="Ej: 1500">
                    </div>
                </div>
            </div>
            <!-- Pestañas y Resultado Total -->
            <div class="mt-10">
                <div class="flex justify-center mb-4">
                    <div class="bg-gray-200 rounded-lg p-1 flex">
                        <button id="btnBruto" class="plan-toggle-btn px-6 py-2 text-lg font-semibold rounded-md transition-colors duration-300 active">Bruto</button>
                        <button id="btnNeto" class="plan-toggle-btn px-6 py-2 text-lg font-semibold rounded-md transition-colors duration-300">Neto (Impuestos)</button>
                    </div>
                </div>

                <div id="vistaBruta" class="flex justify-center">
                    <div class="bg-gray-800 text-white p-4 rounded-xl text-center w-full max-w-xs shadow-lg">
                        <div class="space-y-4">
                            <div>
                                <h2 id="rentaTotalInicialTitulo" class="text-lg font-medium opacity-80 mb-1">Renta Total Inicial</h2>
                                <p id="rentaTotalInicialEl" class="text-3xl font-bold tracking-tight">€0</p>
                            </div>
                            <div id="rentaTotalFinalContainer">
                                 <h2 class="text-lg font-medium opacity-80 mb-1">Renta Total Final</h2>
                                 <p id="rentaTotalFinalEl" class="text-3xl font-bold tracking-tight">€0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="vistaNeta" class="hidden flex justify-center">
                    <div class="bg-gray-800 text-white p-6 rounded-xl text-center w-full max-w-2xl shadow-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Columna Inicial -->
                            <div id="netoInicialContainer" class="space-y-3">
                                <h3 class="text-2xl font-semibold mb-3">Renta Inicial</h3>
                                <div class="flex justify-between text-base">
                                    <span class="text-gray-400">Anual Bruta:</span>
                                    <span id="netoAnualBrutoInicial" class="font-semibold">€0</span>
                                </div>
                                <div class="flex justify-between text-base">
                                    <span class="text-gray-400">Impuestos (est.):</span>
                                    <span id="netoImpuestosInicial" class="font-semibold text-red-400">- €0</span>
                                </div>
                                <hr class="border-gray-600">
                                <h4 class="text-xl font-medium opacity-80 pt-2">Renta Neta Mensual (est.)</h4>
                                <p id="netoMensualInicial" class="text-4xl font-bold tracking-tight text-green-400">€0</p>
                            </div>
                            <!-- Columna Final -->
                            <div id="netoFinalContainer" class="space-y-3">
                                <h3 class="text-2xl font-semibold mb-3">Renta Final</h3>
                                <div class="flex justify-between text-base">
                                    <span class="text-gray-400">Anual Bruta:</span>
                                    <span id="netoAnualBrutoFinal" class="font-semibold">€0</span>
                                </div>
                                <div class="flex justify-between text-base">
                                    <span class="text-gray-400">Impuestos (est.):</span>
                                    <span id="netoImpuestosFinal" class="font-semibold text-red-400">- €0</span>
                                </div>
                                <hr class="border-gray-600">
                                <h4 class="text-xl font-medium opacity-80 pt-2">Renta Neta Mensual Final (est.)</h4>
                                <p id="netoMensualFinal" class="text-4xl font-bold tracking-tight text-green-400">€0</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-6">Estimación fiscal simplificada (IRPF Bizkaia 2024). Consulte a un asesor fiscal.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Desglose Anual -->
        <div id="tabla-container" class="mt-8 bg-white rounded-2xl shadow-xl p-6 md:p-8 hidden">
            <h2 id="tabla-titulo" class="text-3xl font-bold text-gray-800 mb-6 text-center"></h2>
            <div class="overflow-x-auto">
                <table class="min-w-full text-base">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-center font-semibold text-gray-600 tracking-wider">Año</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-600 tracking-wider">Renta Mensual</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-600 tracking-wider">Balance Inicial</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-600 tracking-wider">Balance Final</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-cuerpo" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- ELEMENTOS DEL DOM ---
        const ahorrosInput = document.getElementById('ahorrosJubilacion');
        const revalorizacionInput = document.getElementById('revalorizacionAnual');
        const btnTemporal = document.getElementById('btnTemporal');
        const btnVitaliciaSostenible = document.getElementById('btnVitaliciaSostenible');
        const btnVitaliciaEV = document.getElementById('btnVitaliciaEV');
        
        const rentaInicialEl = document.getElementById('rentaInicial');
        const rentaFinalEl = document.getElementById('rentaFinal');
        const rentaVitaliciaEl = document.getElementById('rentaVitalicia');
        const errorMensajeEl = document.getElementById('errorMensaje');
        const resultadoTitulo = document.getElementById('resultadoTitulo');

        const camposTemporal = document.getElementById('camposTemporal');
        const camposEsperanzaVida = document.getElementById('camposEsperanzaVida');
        const resultadoTemporalEV = document.getElementById('resultadoTemporalEV');
        const resultadoVitaliciaSostenible = document.getElementById('resultadoVitaliciaSostenible');
        
        const aniosInput = document.getElementById('aniosCobro');
        const actualizacionInput = document.getElementById('actualizacionAnual');
        const aniosVal = document.getElementById('aniosCobroVal');
        const actualizacionVal = document.getElementById('actualizacionAnualVal');

        const edadActualInput = document.getElementById('edadActual');
        const sexoInput = document.getElementById('sexo');
        const actualizacionInputEV = document.getElementById('actualizacionAnualEV');
        const actualizacionValEV = document.getElementById('actualizacionAnualValEV');

        const tablaContainer = document.getElementById('tabla-container');
        const tablaCuerpo = document.getElementById('tabla-cuerpo');
        const tablaTitulo = document.getElementById('tabla-titulo');
        const revalorizacionVal = document.getElementById('revalorizacionAnualVal');

        const pensionPublicaInput = document.getElementById('pensionPublicaInput');
        const togglePensionPublica = document.getElementById('togglePensionPublica');
        const planificacionCompletaContainer = document.getElementById('planificacionCompletaContainer');
        
        const btnBruto = document.getElementById('btnBruto');
        const btnNeto = document.getElementById('btnNeto');
        const vistaBruta = document.getElementById('vistaBruta');
        const vistaNeta = document.getElementById('vistaNeta');
        
        const rentaTotalInicialEl = document.getElementById('rentaTotalInicialEl');
        const rentaTotalFinalEl = document.getElementById('rentaTotalFinalEl');
        const rentaTotalFinalContainer = document.getElementById('rentaTotalFinalContainer');
        const rentaTotalInicialTitulo = document.getElementById('rentaTotalInicialTitulo');

        const netoInicialContainer = document.getElementById('netoInicialContainer');
        const netoAnualBrutoInicial = document.getElementById('netoAnualBrutoInicial');
        const netoImpuestosInicial = document.getElementById('netoImpuestosInicial');
        const netoMensualInicial = document.getElementById('netoMensualInicial');
        
        const netoFinalContainer = document.getElementById('netoFinalContainer');
        const netoAnualBrutoFinal = document.getElementById('netoAnualBrutoFinal');
        const netoImpuestosFinal = document.getElementById('netoImpuestosFinal');
        const netoMensualFinal = document.getElementById('netoMensualFinal');


        // --- DATOS ---
        const lifeExpectancyData = { 
            50: { male: 32.2, female: 36.6 }, 55: { male: 27.7, female: 32.0 },
            60: { male: 23.3, female: 27.4 }, 65: { male: 19.2, female: 23.0 },
            70: { male: 15.5, female: 18.9 }, 75: { male: 12.1, female: 15.1 },
            80: { male: 9.1, female: 11.7 }, 85: { male: 6.6, female: 8.6 },
            90: { male: 4.6, female: 6.0 }, 95: { male: 3.1, female: 4.0 },
        };
        const currencyFormatter = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' });
        let rentaType = 'temporal';

        // --- FUNCIONES ---
        function getLifeExpectancy(age, gender) {
            const ageKeys = Object.keys(lifeExpectancyData).map(Number).sort((a, b) => b - a);
            const applicableAge = ageKeys.find(key => age >= key) || Math.min(...ageKeys);
            return lifeExpectancyData[applicableAge]?.[gender] ?? 0;
        }

        function actualizarValoresSliders() {
            aniosVal.textContent = `${aniosInput.value} años`;
            revalorizacionVal.textContent = `${parseFloat(revalorizacionInput.value).toFixed(1)}%`;
            actualizacionVal.textContent = `${parseFloat(actualizacionInput.value).toFixed(1)}%`;
            actualizacionValEV.textContent = `${parseFloat(actualizacionInputEV.value).toFixed(1)}%`;
        }
        
        const calculateBizkaiaTax = (income) => {
            const brackets = [
                { limit: 127680, rate: 0.49 }, { limit: 95760, rate: 0.47 },
                { limit: 71820, rate: 0.46 }, { limit: 53870, rate: 0.40 },
                { limit: 35910, rate: 0.35 }, { limit: 17960, rate: 0.28 },
                { limit: 0, rate: 0.23 }
            ];
            let tax = 0;
            let remainingIncome = income;
            for (const bracket of brackets) {
                if (remainingIncome > bracket.limit) {
                    tax += (remainingIncome - bracket.limit) * bracket.rate;
                    remainingIncome = bracket.limit;
                }
            }
            return tax;
        };

        function calcularRentaTotal() {
            if (planificacionCompletaContainer.classList.contains('hidden')) {
                 return;
            }
            const pensionPublica = parseFloat(pensionPublicaInput.value) || 0;

            const parseCurrency = (text) => {
                if (text && text !== '---' && text !== '€0') {
                    const cleanValue = text.replace('€', '').replace(/\./g, '').replace(',', '.').trim();
                    return parseFloat(cleanValue) || 0;
                }
                return 0;
            };

            let rentaPrivadaInicial = 0;
            let rentaPrivadaFinal = 0;

            if (rentaType === 'vitaliciaSostenible') {
                rentaPrivadaInicial = parseCurrency(rentaVitaliciaEl.textContent);
                rentaPrivadaFinal = rentaPrivadaInicial;
                // Bruto
                rentaTotalFinalContainer.style.display = 'none';
                rentaTotalInicialTitulo.textContent = 'Renta Total Mensual';
                // Neto
                netoFinalContainer.style.display = 'none';
                netoInicialContainer.querySelector('h3').textContent = 'Renta';
            } else {
                rentaPrivadaInicial = parseCurrency(rentaInicialEl.textContent);
                rentaPrivadaFinal = parseCurrency(rentaFinalEl.textContent);
                // Bruto
                rentaTotalFinalContainer.style.display = 'block';
                rentaTotalInicialTitulo.textContent = 'Renta Total Inicial';
                // Neto
                netoFinalContainer.style.display = 'block';
                netoInicialContainer.querySelector('h3').textContent = 'Renta Inicial';
            }

            // Cálculo Bruto
            rentaTotalInicialEl.textContent = currencyFormatter.format(pensionPublica + rentaPrivadaInicial);
            rentaTotalFinalEl.textContent = currencyFormatter.format(pensionPublica + rentaPrivadaFinal);

            // --- Cálculo Neto ---

            // Inicial
            const grossAnnualIncomeInitial = (rentaPrivadaInicial * 12) + (pensionPublica * 14);
            const taxAmountInitial = calculateBizkaiaTax(grossAnnualIncomeInitial);
            const netAnnualIncomeInitial = grossAnnualIncomeInitial - taxAmountInitial;
            const netMonthlyIncomeInitial = netAnnualIncomeInitial / 12;
            
            netoAnualBrutoInicial.textContent = currencyFormatter.format(grossAnnualIncomeInitial);
            netoImpuestosInicial.textContent = `- ${currencyFormatter.format(taxAmountInitial)}`;
            netoMensualInicial.textContent = currencyFormatter.format(netMonthlyIncomeInitial);
            
            // Final
            const grossAnnualIncomeFinal = (rentaPrivadaFinal * 12) + (pensionPublica * 14);
            const taxAmountFinal = calculateBizkaiaTax(grossAnnualIncomeFinal);
            const netAnnualIncomeFinal = grossAnnualIncomeFinal - taxAmountFinal;
            const netMonthlyIncomeFinal = netAnnualIncomeFinal / 12;
            
            netoAnualBrutoFinal.textContent = currencyFormatter.format(grossAnnualIncomeFinal);
            netoImpuestosFinal.textContent = `- ${currencyFormatter.format(taxAmountFinal)}`;
            netoMensualFinal.textContent = currencyFormatter.format(netMonthlyIncomeFinal);
        }

        function calcularYMostrar() {
            errorMensajeEl.textContent = '';
            const ahorros = parseFloat(ahorrosInput.value);
            const revalorizacion = parseFloat(revalorizacionInput.value) / 100;

            if (isNaN(ahorros) || ahorros <= 0) {
                errorMensajeEl.textContent = 'Introduce un ahorro inicial positivo.';
                rentaInicialEl.textContent = '---'; rentaFinalEl.textContent = '---'; rentaVitaliciaEl.textContent = '---';
                tablaContainer.classList.add('hidden');
                return;
            }

            let anios, actualizacion;

            if (rentaType === 'temporal' || rentaType === 'vitaliciaEV') {
                if (rentaType === 'temporal') {
                    anios = parseInt(aniosInput.value);
                    actualizacion = parseFloat(actualizacionInput.value) / 100;
                } else { 
                    const edad = parseInt(edadActualInput.value);
                    const sexo = sexoInput.value;
                    if (isNaN(edad) || edad < 50) {
                         errorMensajeEl.textContent = 'Edad debe ser 50 o mayor.'; return;
                    }
                    anios = getLifeExpectancy(edad, sexo);
                    actualizacion = parseFloat(actualizacionInputEV.value) / 100;
                }
                
                let rentaInicial = 0;
                if (revalorizacion !== actualizacion) {
                    let r_eff = (1 + revalorizacion) / (1 + actualizacion) - 1;
                    if (Math.abs(r_eff) > 1e-9) {
                       rentaInicial = (ahorros * r_eff) / (1 - Math.pow(1 + r_eff, -anios)) / 12;
                    } else { rentaInicial = (ahorros / anios) / 12; }
                } else { rentaInicial = (ahorros / anios) / 12; }

                if (isFinite(rentaInicial) && rentaInicial > 0) {
                    rentaInicialEl.textContent = currencyFormatter.format(rentaInicial);
                    rentaFinalEl.textContent = currencyFormatter.format(rentaInicial * Math.pow(1 + actualizacion, anios - 1));
                    generarYMostrarTabla(rentaInicial, anios, actualizacion);
                } else {
                     errorMensajeEl.textContent = 'Parámetros no sostenibles.';
                     rentaInicialEl.textContent = '€0'; rentaFinalEl.textContent = '€0';
                     tablaContainer.classList.add('hidden');
                }
            } else { 
                if (revalorizacion <= 0) {
                    errorMensajeEl.textContent = 'Se necesita revalorización positiva.';
                    rentaVitaliciaEl.textContent = currencyFormatter.format(0);
                    return;
                }
                rentaVitaliciaEl.textContent = currencyFormatter.format((ahorros * revalorizacion) / 12);
            }
            calcularRentaTotal();
        }

        function generarYMostrarTabla(rentaInicialMensual, anios, actualizacion) {
            tablaCuerpo.innerHTML = '';
            if (!isFinite(rentaInicialMensual) || rentaInicialMensual <= 0) {
                tablaContainer.classList.add('hidden'); return;
            }
            const ahorros = parseFloat(ahorrosInput.value);
            const revalorizacion = parseFloat(revalorizacionInput.value) / 100;
            
            let balance = ahorros;
            let rentaMensualActual = rentaInicialMensual;
            const numAnios = Math.floor(anios);

            for (let anio = 1; anio <= numAnios; anio++) {
                const balanceInicialAnio = balance;
                balance = (balance - (rentaMensualActual * 12)) * (1 + revalorizacion);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-center text-gray-700 font-medium">${anio}</td>
                    <td class="px-4 py-3 text-right text-gray-700">${currencyFormatter.format(rentaMensualActual)}</td>
                    <td class="px-4 py-3 text-right text-gray-700">${currencyFormatter.format(balanceInicialAnio)}</td>
                    <td class="px-4 py-3 text-right text-gray-700">${currencyFormatter.format(balance < 0 ? 0 : balance)}</td>
                `;
                tablaCuerpo.appendChild(row);
                rentaMensualActual *= (1 + actualizacion);
            }
            tablaContainer.classList.remove('hidden');
        }

        function actualizarVisibilidadPlanCompleto() {
            planificacionCompletaContainer.classList.toggle('hidden', !togglePensionPublica.checked);
            if (!togglePensionPublica.checked) pensionPublicaInput.value = '';
            calcularRentaTotal();
        }
        
        function actualizarUI() {
            [btnTemporal, btnVitaliciaSostenible, btnVitaliciaEV].forEach(btn => btn.classList.remove('active'));

            if (rentaType === 'temporal') {
                btnTemporal.classList.add('active');
                camposTemporal.style.display = 'block';
                camposEsperanzaVida.style.display = 'none';
                resultadoTemporalEV.classList.remove('hidden');
                resultadoVitaliciaSostenible.classList.add('hidden');
                tablaContainer.classList.remove('hidden');
                resultadoTitulo.textContent = "Renta Temporal";
                tablaTitulo.textContent = "Desglose Anual (Renta Temporal)";
            } else if (rentaType === 'vitaliciaSostenible') {
                btnVitaliciaSostenible.classList.add('active');
                camposTemporal.style.display = 'none';
                camposEsperanzaVida.style.display = 'none';
                resultadoTemporalEV.classList.add('hidden');
                resultadoVitaliciaSostenible.classList.remove('hidden');
                tablaContainer.classList.add('hidden');
                resultadoTitulo.textContent = "Renta Vitalicia (Sostenible)";
            } else { // vitaliciaEV
                btnVitaliciaEV.classList.add('active');
                camposTemporal.style.display = 'none';
                camposEsperanzaVida.style.display = 'block';
                resultadoTemporalEV.classList.remove('hidden');
                resultadoVitaliciaSostenible.classList.add('hidden');
                tablaContainer.classList.remove('hidden');
                const edad = parseInt(edadActualInput.value);
                const aniosEV = getLifeExpectancy(edad, sexoInput.value) || 0;
                resultadoTitulo.textContent = "Renta Vitalicia (Según Esperanza de Vida)";
                tablaTitulo.textContent = `Desglose Anual (hasta ${aniosEV.toFixed(1)} años)`;
            }
            calcularYMostrar();
        }

        // --- EVENT LISTENERS ---
        [ahorrosInput, revalorizacionInput, aniosInput, actualizacionInput, edadActualInput, sexoInput, actualizacionInputEV]
            .forEach(input => input.addEventListener('input', () => {
                actualizarValoresSliders();
                actualizarUI(); 
            }));

        btnTemporal.addEventListener('click', () => { rentaType = 'temporal'; actualizarUI(); });
        btnVitaliciaSostenible.addEventListener('click', () => { rentaType = 'vitaliciaSostenible'; actualizarUI(); });
        btnVitaliciaEV.addEventListener('click', () => { rentaType = 'vitaliciaEV'; actualizarUI(); });
        
        pensionPublicaInput.addEventListener('input', calcularRentaTotal);
        togglePensionPublica.addEventListener('change', actualizarVisibilidadPlanCompleto);
        
        btnBruto.addEventListener('click', () => {
            btnBruto.classList.add('active');
            btnNeto.classList.remove('active');
            vistaBruta.classList.remove('hidden');
            vistaNeta.classList.add('hidden');
        });

        btnNeto.addEventListener('click', () => {
            btnNeto.classList.add('active');
            btnBruto.classList.remove('active');
            vistaNeta.classList.remove('hidden');
            vistaBruta.classList.add('hidden');
        });

        // Inicialización
        window.addEventListener('load', () => {
            actualizarValoresSliders();
            actualizarUI();
            actualizarVisibilidadPlanCompleto();
        });
    </script>
</body>
</html>