import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { renderDashboardChart, renderXRayChart, renderAllocationDonut, renderRiskMap, renderCorrelationHeatmap, renderStyleBox } from './chartEngine.js';
import { showToast, formatCurrency } from './ui.js';

// --- ESTADO GLOBAL ---
let fundDatabase = [];
let currentPortfolio = [];
let proposedPortfolio = [];
let db, functions, auth;
let xrayFullData = { port: [], benchmarks: {} }; 
let currentBenchmarkKey = 'moderate'; 

// --- UTILS DE UI ---
const openModal = (id) => { 
    const m = document.getElementById(id); 
    if(m) { 
        m.classList.remove('hidden','opacity-0'); 
        m.classList.add('flex','opacity-100'); 
    }
};
window.closeModal = (id) => { 
    const m = document.getElementById(id); 
    if(m) { 
        m.classList.remove('opacity-100'); 
        m.classList.add('opacity-0'); 
        setTimeout(() => { m.classList.add('hidden'); m.classList.remove('flex'); }, 300); 
    }
};

// --- ADAPTADOR DE DATOS (Normaliza tu DB para la App) ---
function normalizeFundData(docData) {
    // 1. Detectar Tipo (RV vs RF) usando tus campos 'metrics'
    let tipoCalc = 'Mixto';
    const eq = docData.metrics?.equity || 0;
    const bd = docData.metrics?.bond || 0;
    const cash = docData.metrics?.cash || 0;
    
    if (eq >= 60) tipoCalc = 'RV';
    else if (bd >= 60) tipoCalc = 'RF';
    else if (cash >= 60) tipoCalc = 'Monetario';

    // 2. Normalizar Estilo (Style Box)
    let sizeCalc = 'Large';
    let styleCalc = 'Blend';
    
    if (docData.style) {
        // Traducir Estilo (Espa침ol -> Ingl칠s est치ndar)
        const s = (docData.style.investment_style || "").toLowerCase();
        if (s.includes('valor')) styleCalc = 'Value';
        else if (s.includes('crecimiento')) styleCalc = 'Growth';
        
        // Calcular Tama침o dominante
        const caps = docData.style.market_cap || {};
        const giant = caps.gigante || 0;
        const large = caps.grande || 0;
        const mid = caps.mediano || 0;
        const small = (caps.peque침o || 0) + (caps.micro || 0);
        
        if (small > mid && small > (giant + large)) sizeCalc = 'Small';
        else if (mid > (giant + large) && mid > small) sizeCalc = 'Mid';
    }

    // 3. Normalizar M칠tricas (Escalas 0-100 -> 0-1)
    let ret3y = 0.05; 
    if (docData.returns && docData.returns['3y_annualized'] != null) {
        ret3y = docData.returns['3y_annualized'] / 100;
    }
    
    let vol = 0.10;
    if (docData.perf && docData.perf.volatility != null) {
        vol = docData.perf.volatility / 100;
    }

    return {
        ...docData,
        // Campos estandarizados internos
        std_type: tipoCalc, 
        std_style: { size: sizeCalc, investment: styleCalc },
        std_perf: { volatility: vol, cagr3y: ret3y }
    };
}

// --- INICIO APP ---
export async function startApp(user, firebaseApp) {
    db = getFirestore(firebaseApp);
    functions = getFunctions(firebaseApp, "europe-west1");
    auth = getAuth(firebaseApp);
    document.getElementById('user-display').textContent = user.email;
    
    setupListeners();
    
    // Iniciar carga de datos
    await loadData();

    // FORZAR RENDERIZADO INICIAL DEL GR츼FICO (Soluci칩n al "gr치fico vac칤o")
    setTimeout(() => {
        updatePortfolioUI(); 
    }, 500);
}

function setupListeners() {
    // Buscador y Formularios
    document.getElementById('fund-search').addEventListener('input', (e) => filterGrid(e.target.value));
    document.getElementById('portfolio-form').addEventListener('submit', generateManualProposal);
    document.getElementById('run-backtest-btn').addEventListener('click', runXRay);
    
    // Importador CSV
    const csvInput = document.getElementById('csv-upload');
    if(csvInput) csvInput.addEventListener('change', handleCSVUpload);

    // Flujo Optimizaci칩n Real
    const btnOpt = document.getElementById('btn-optimize');
    if(btnOpt) btnOpt.addEventListener('click', runOptimizationWithComparison);

    // Flujo Editor Avanzado
    const btnAccept = document.getElementById('btn-accept-optimization');
    if(btnAccept) btnAccept.addEventListener('click', () => { closeModal('comparison-modal'); openAdvancedEditor(); });

    const btnSaveFinal = document.getElementById('btn-save-final-portfolio');
    if(btnSaveFinal) btnSaveFinal.addEventListener('click', saveFinalPortfolio);

    document.getElementById('editor-add-fund-input').addEventListener('input', handleEditorSearch);
    
    // Noticias
    const btnNews = document.getElementById('btn-news-bell');
    if(btnNews) btnNews.addEventListener('click', openNews);

    // X-Ray Controles
    window.updateXRayTimeframe = (period) => {
        ['1y','3y','5y'].forEach(p => {
             const btn = document.getElementById(`btn-${p}`);
             if(p === period.toLowerCase()) { btn.classList.add('bg-white','shadow','text-[#0B2545]'); btn.classList.remove('text-slate-500'); }
             else { btn.classList.remove('bg-white','shadow','text-[#0B2545]'); btn.classList.add('text-slate-500'); }
        });
        document.getElementById('xray-period-input').value = period; 
        filterAndRenderXRay();
    };

    const benchSelect = document.getElementById('benchmark-selector');
    if(benchSelect) benchSelect.addEventListener('change', (e) => { currentBenchmarkKey = e.target.value; filterAndRenderXRay(); });

    // Herramientas Extra
    document.getElementById('btn-open-costs-tool').addEventListener('click', () => { renderCosts(); openModal('costs-detail-modal'); });
    const btnTactical = document.getElementById('btn-open-tactical');
    if(btnTactical) btnTactical.addEventListener('click', () => openModal('tactical-modal'));
}

// --- GESTI칍N DE DATOS ---
async function loadData() {
    try {
        const snap = await getDocs(collection(db, "funds_v2"));
        fundDatabase = [];
        // Filtro de exclusi칩n estricta
        const BLACKLIST = ['IE00B18GC888', 'IE00B03HCZ61']; 
        
        snap.forEach(d => { 
            if (!BLACKLIST.includes(d.id)) {
                const raw = d.data();
                // Normalizamos al cargar
                const clean = normalizeFundData({isin: d.id, ...raw});
                fundDatabase.push(clean);
            }
        });
        renderGrid(fundDatabase);
    } catch(e) { console.error(e); }
}

async function handleCSVUpload(e) {
    const file = e.target.files[0];
    if(!file) return;
    const text = await file.text();
    const rows = text.split('\n').map(r => r.split(';'));
    let imported = [], notFound = [], totalVal = 0;
    
    // Parseo CSV (Col 1: ISIN, Col Final: Valor)
    for(let i=1; i<rows.length; i++) {
        const row = rows[i];
        if(row.length < 5) continue; 
        const isin = row[1]?.trim();
        
        let valStr = row[row.length-1]?.trim() || "0";
        valStr = valStr.replace(/\./g, '').replace(',', '.'); 
        const value = parseFloat(valStr) || 0;
        
        if(!isin) continue;
        const fund = fundDatabase.find(f => f.isin === isin);
        if(fund) { imported.push({ ...fund, rawValue: value }); totalVal += value; } else { notFound.push(isin); }
    }
    
    if(notFound.length > 0) showToast(`Alerta: ${notFound.length} fondos no encontrados.`, 'error');
    if(imported.length > 0) {
        currentPortfolio = imported.map(f => ({ ...f, weight: (f.rawValue / totalVal) * 100 }));
        document.getElementById('investment_amount').value = Math.round(totalVal);
        updatePortfolioUI();
        showToast("Cartera importada correctamente", "success");
    }
}

// --- UI PRINCIPAL ---
function renderGrid(list) {
    const c = document.getElementById('main-grid-container');
    c.innerHTML = list.slice(0, 50).map(f => `
        <div class="p-3 border-b border-slate-100 hover:bg-slate-50 cursor-pointer flex justify-between items-center group transition-colors" onclick="addFund('${f.isin}')">
            <div><div class="text-xs font-bold text-[#0B2545] truncate w-40">${f.name}</div><div class="text-[9px] text-slate-400 font-mono">${f.isin}</div></div>
            <span class="text-[#D4AF37] font-bold opacity-0 group-hover:opacity-100 text-lg">+</span>
        </div>
    `).join('');
}
function filterGrid(term) { renderGrid(fundDatabase.filter(f => f.name.toLowerCase().includes(term.toLowerCase()) || f.isin.toLowerCase().includes(term.toLowerCase()))); }

window.addFund = (isin) => {
    const f = fundDatabase.find(x => x.isin === isin);
    if(f && !currentPortfolio.some(x=>x.isin===isin)) { currentPortfolio.push({ ...f, weight: 0 }); updatePortfolioUI(); showToast("Fondo a침adido"); }
};
window.removeFund = (isin) => { currentPortfolio = currentPortfolio.filter(x=>x.isin!==isin); updatePortfolioUI(); };
window.updateWeight = (isin, val) => { const f = currentPortfolio.find(x=>x.isin===isin); if(f) f.weight = parseFloat(val)||0; updatePortfolioUI(); };

function updatePortfolioUI() {
    const tbody = document.getElementById('portfolio-table-body');
    const totalCap = parseFloat(document.getElementById('investment_amount').value) || 100000;
    let totalW = 0, rv=0, rf=0, cash=0;
    
    tbody.innerHTML = currentPortfolio.map(f => {
        totalW += f.weight;
        const val = totalCap * (f.weight / 100);
        
        // Clasificaci칩n usando datos normalizados
        if(f.std_type === 'RV') rv += f.weight;
        else if(f.std_type === 'RF') rf += f.weight;
        else cash += f.weight;

        // Fuentes ajustadas (text-xs para nombre, text-sm para valores)
        return `<tr class="border-b border-slate-50 hover:bg-slate-50 group">
            <td class="p-3 truncate max-w-[180px] font-medium text-[#0B2545] text-xs">${f.name}</td>
            <td class="p-3 text-right">
                <input type="number" class="w-12 text-right bg-transparent outline-none font-bold text-[#0B2545] text-xs" 
                       value="${f.weight.toFixed(2)}" onchange="updateWeight('${f.isin}', this.value)">%
            </td>
            <td class="p-3 text-right font-mono text-slate-500 font-bold text-xs">${formatCurrency(val)}</td>
            <td class="p-3 text-right"><button onclick="removeFund('${f.isin}')" class="text-slate-300 hover:text-red-500">&times;</button></td>
        </tr>`;
    }).join('');

    document.getElementById('footer-total-weight').textContent = totalW.toFixed(1) + '%';
    document.getElementById('footer-total-amount').textContent = formatCurrency(totalCap * (totalW/100));
    
    // Renderizado de Componentes Visuales
    renderAllocationDonut({rv, rf, other: cash});
    renderStyleBox(currentPortfolio);

    // --- C츼LCULO DE PROYECCI칍N (Siempre activa) ---
    let portfolioVol = 0.08; 
    let portfolioRet = 0.05;

    if(totalW > 0.1) {
        let wVol = 0, wRet = 0;
        currentPortfolio.forEach(f => {
            const w = f.weight / 100;
            wVol += (f.std_perf.volatility) * w;
            wRet += (f.std_perf.cagr3y) * w;
        });
        const finalVol = wVol * 0.85; 
        
        portfolioVol = Math.max(0.04, finalVol);
        portfolioRet = wRet;

        document.getElementById('mini-volatility').textContent = (finalVol*100).toFixed(2) + '%';
        document.getElementById('mini-return').textContent = (wRet*100).toFixed(2) + '%';
        const sharpe = finalVol > 0 ? (wRet - 0.025) / finalVol : 0;
        document.getElementById('mini-sharpe').textContent = sharpe.toFixed(2);
    } else {
        document.getElementById('mini-volatility').textContent = "-";
        document.getElementById('mini-return').textContent = "-";
        document.getElementById('mini-sharpe').textContent = "-";
    }

    // Puntos de Proyecci칩n Monte Carlo
    const points = []; 
    let v = 100; 
    const dailyVol = portfolioVol / 12; 
    const dailyRet = portfolioRet / 252;

    for(let i=0; i<150; i++){
        const change = dailyRet + (Math.random() - 0.5) * 2 * dailyVol;
        v *= (1 + change);
        points.push({x: i, y: v});
    }
    
    renderDashboardChart(points);
}

function generateManualProposal(e) { 
    e.preventDefault();
    const num = parseInt(document.getElementById('number_of_funds').value) || 5;
    if(!fundDatabase.length) return showToast("Cargando datos...", "info");
    const selected = fundDatabase.slice(0, num);
    const weight = selected.length > 0 ? (100 / selected.length) : 0;
    currentPortfolio = selected.map(f => ({ ...f, weight: weight }));
    updatePortfolioUI();
    showToast(`Propuesta manual generada (${num} activos)`, "success");
}

// --- OPTIMIZACI칍N REAL (Conectada a Python) ---
async function runOptimizationWithComparison() {
    if(!currentPortfolio.length) return showToast("A침ade fondos primero", "error");
    
    const btn = document.getElementById('btn-optimize'); 
    const prevHTML = btn.innerHTML;
    btn.innerHTML = `<span class="animate-spin">丘뙖잺</span> Conectando con Motor Quant...`; 
    btn.disabled = true;

    try {
        const isinList = currentPortfolio.map(f => f.isin);
        const riskLevel = document.getElementById('risk_level').value;

        // Llamada a la funci칩n REAL de Python
        const fn = httpsCallable(functions, 'optimize_portfolio_quant');
        
        console.log("Enviando a optimizar:", isinList);
        const res = await fn({ assets: isinList, risk_level: parseInt(riskLevel) });
        const result = res.data;

        if (result.status === 'error') throw new Error(result.warnings[0] || "Error motor.");
        
        const weights = result.weights || {};
        proposedPortfolio = currentPortfolio.map(f => ({
            ...f,
            weight: (weights[f.isin] || 0) * 100
        })).filter(f => f.weight > 0.01);
        
        // M칠tricas reales
        const newSharpe = result.metrics.sharpe || 0;
        const newVol = result.metrics.volatility || 0;
        const newRet = result.metrics.return || 0;
        const oldSharpe = parseFloat(document.getElementById('mini-sharpe').textContent) || 0.5;
        
        document.getElementById('comp-old-sharpe').textContent = oldSharpe.toFixed(2);
        document.getElementById('comp-new-sharpe').textContent = newSharpe.toFixed(2);
        
        const diff = ((newSharpe - oldSharpe) / oldSharpe) * 100;
        const diffSign = diff > 0 ? "+" : "";
        document.getElementById('comp-diff-sharpe').textContent = `${diffSign}${diff.toFixed(0)}%`;
        
        document.getElementById('comp-diff-ret').textContent = `${(newRet*100).toFixed(2)}% (Obj)`;
        document.getElementById('comp-diff-vol').textContent = `${(newVol*100).toFixed(2)}% (Est)`;

        openModal('comparison-modal');
        showToast("C치lculo Markowitz completado", "success");

    } catch(e) {
        console.error("Error Optimizaci칩n:", e);
        showToast("Error: " + e.message, "error");
    } finally {
        btn.innerHTML = prevHTML;
        btn.disabled = false;
    }
}

function openAdvancedEditor() { openModal('advanced-editor-modal'); renderEditorTables(); }
function renderEditorTables() {
    document.getElementById('editor-original-tbody').innerHTML = currentPortfolio.map(f => `<tr class="border-b border-slate-100"><td class="py-2 truncate max-w-[120px]" title="${f.name}">${f.name}</td><td class="text-right font-mono">${f.weight.toFixed(1)}%</td></tr>`).join('');
    renderProposedTable();
}
function renderProposedTable() {
    const tbodyNew = document.getElementById('editor-proposed-tbody');
    let totalW = 0;
    tbodyNew.innerHTML = proposedPortfolio.map(f => {
        totalW += f.weight;
        return `<tr><td class="p-3 text-[#0B2545] font-medium text-xs">${f.name}</td><td class="p-3 text-right text-[10px] text-slate-400 font-mono">${f.isin}</td><td class="p-3 text-right"><input type="number" class="w-16 text-right border rounded p-1 text-xs font-bold text-[#0B2545]" value="${f.weight.toFixed(2)}" onchange="window.updateProposedWeight('${f.isin}', this.value)"></td><td class="p-3 text-center"><button onclick="window.removeProposedFund('${f.isin}')" class="text-red-400 hover:text-red-600 text-lg">&times;</button></td></tr>`;
    }).join('');
    const totalEl = document.getElementById('editor-total-weight-display');
    totalEl.textContent = `Total: ${totalW.toFixed(2)}%`;
    totalEl.className = Math.abs(totalW - 100) < 0.1 ? "text-xs font-bold text-emerald-600" : "text-xs font-bold text-rose-500";
}

window.updateProposedWeight = (isin, val) => { const f = proposedPortfolio.find(x => x.isin === isin); if(f) f.weight = parseFloat(val) || 0; renderProposedTable(); };
window.removeProposedFund = (isin) => { proposedPortfolio = proposedPortfolio.filter(x => x.isin !== isin); renderProposedTable(); };
function handleEditorSearch(e) {
    const term = e.target.value.toLowerCase();
    const resultsDiv = document.getElementById('editor-search-results');
    if(term.length < 3) { resultsDiv.classList.add('hidden'); return; }
    const matches = fundDatabase.filter(f => f.name.toLowerCase().includes(term) || f.isin.toLowerCase().includes(term)).slice(0,5);
    if(matches.length > 0) {
        resultsDiv.innerHTML = matches.map(f => `<div class="p-2 hover:bg-slate-50 cursor-pointer flex justify-between items-center text-xs" onclick="addFundToProposed('${f.isin}')"><span class="truncate max-w-[200px] font-bold text-[#0B2545]">${f.name}</span><span class="text-blue-600 font-bold">+</span></div>`).join('');
        resultsDiv.classList.remove('hidden');
    } else { resultsDiv.classList.add('hidden'); }
}
window.addFundToProposed = (isin) => { const f = fundDatabase.find(x => x.isin === isin); if(f && !proposedPortfolio.some(x=>x.isin===isin)) { proposedPortfolio.push({ ...f, weight: 0 }); renderProposedTable(); document.getElementById('editor-search-results').classList.add('hidden'); document.getElementById('editor-add-fund-input').value = ''; } };
function saveFinalPortfolio() { currentPortfolio = [...proposedPortfolio]; updatePortfolioUI(); closeModal('advanced-editor-modal'); showToast("Cartera definitiva guardada", "success"); }

async function openNews() {
    openModal('news-modal');
    const container = document.getElementById('news-general-container');
    container.innerHTML = '<div class="text-center py-10 text-slate-400 italic animate-pulse">Conectando...</div>';
    try {
        const fn = httpsCallable(functions, 'getFinancialNews');
        const res = await fn();
        const articles = res.data.articles || [];
        if(articles.length === 0) container.innerHTML = '<div class="text-center py-10 text-slate-400">Sin noticias recientes.</div>';
        else container.innerHTML = articles.map(a => `<div class="mb-4 p-4 border border-slate-100 rounded bg-slate-50 hover:bg-white hover:shadow-md transition-all cursor-pointer"><div class="flex justify-between items-start mb-2"><span class="text-[9px] font-bold uppercase tracking-wider text-[#D4AF37] bg-[#0B2545] px-2 py-0.5 rounded">${a.source||'Feed'}</span><span class="text-[9px] text-slate-400 font-mono">${new Date().toLocaleDateString()}</span></div><h4 class="text-sm font-bold text-[#0B2545] mb-2 leading-tight">${a.title}</h4><p class="text-xs text-slate-600 leading-relaxed">${a.summary}</p></div>`).join('');
    } catch(e) { container.innerHTML = '<div class="text-center py-10 text-rose-400">Error de conexi칩n.</div>'; }
}

async function runXRay() { 
    if(!currentPortfolio.length) return showToast("Cartera vac칤a", "error");
    const btn = document.getElementById('run-backtest-btn'); btn.innerText = "Calculando..."; btn.disabled = true;
    try {
        const fn = httpsCallable(functions, 'performbacktest');
        const res = await fn({ portfolioData: currentPortfolio });
        const { metrics, portfolioSeries, benchmarkSeries, synthetics, correlationMatrix } = res.data;
        xrayFullData = { port: portfolioSeries, benchmarks: benchmarkSeries };
        if(metrics) {
            document.getElementById('metric-cagr').textContent = (metrics.cagr*100).toFixed(2)+'%';
            document.getElementById('metric-volatility').textContent = (metrics.vol1y*100).toFixed(2)+'%';
            document.getElementById('metric-sharpe').textContent = metrics.sharpe1y.toFixed(2);
            document.getElementById('metric-maxdd').textContent = (metrics.maxDrawdown*100).toFixed(2)+'%';
        }
        openModal('analysis-modal');
        document.getElementById('xray-period-input').value = '3Y';
        window.updateXRayTimeframe('3Y'); 
        setTimeout(() => renderRiskMap(metrics, currentPortfolio, synthetics), 300);
        renderCorrelationHeatmap(correlationMatrix, currentPortfolio.map(f => f.name));
    } catch(e) { console.error(e); showToast("Error X-Ray", "error"); } finally { btn.innerText = "游늵 X-Ray / Backtest"; btn.disabled = false; }
}

function filterAndRenderXRay() {
    if(!xrayFullData.port.length) return;
    const period = document.getElementById('xray-period-input').value || '3Y';
    const benchmarkKey = currentBenchmarkKey || 'moderate';
    const today = new Date(); const cutoff = new Date();
    if(period === '1Y') cutoff.setFullYear(today.getFullYear() - 1); else if(period === '3Y') cutoff.setFullYear(today.getFullYear() - 3); else cutoff.setFullYear(today.getFullYear() - 10);
    const filteredPort = xrayFullData.port.filter(p => new Date(p.x) >= cutoff);
    const selectedBenchSeries = xrayFullData.benchmarks[benchmarkKey] || [];
    const filteredBench = selectedBenchSeries.filter(p => new Date(p.x) >= cutoff);
    const pData = filteredPort.map(p => ({x: new Date(p.x).getTime(), y: p.y}));
    const bData = filteredBench.map(p => ({x: new Date(p.x).getTime(), y: p.y}));
    renderXRayChart(pData, bData, benchmarkKey.charAt(0).toUpperCase() + benchmarkKey.slice(1));
}

function renderCosts() { 
    const tbody = document.getElementById('costs-table-body');
    const cap = parseFloat(document.getElementById('investment_amount').value) || 0;
    let total = 0;
    tbody.innerHTML = currentPortfolio.map(f => {
        const ter = (f.costs?.ter || 1.5) / 100; const costVal = cap * (f.weight/100) * ter; total += costVal;
        return `<tr class="border-b border-slate-100"><td class="p-2 text-slate-600">${f.name}</td><td class="p-2 text-right font-mono">${(ter*100).toFixed(2)}%</td><td class="p-2 text-right font-mono font-bold text-slate-800">${formatCurrency(costVal)}</td></tr>`;
    }).join('');
    document.getElementById('final-cost-result').textContent = formatCurrency(total);
}